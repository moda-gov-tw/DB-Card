# å¼±é»ä¿®è£œæŠ€è¡“æ¶æ§‹

**å°ˆæ¡ˆ**: NFC æ•¸ä½åç‰‡ç³»çµ±å®‰å…¨ä¿®è£œ  
**ç‰ˆæœ¬**: v2.0 (æ›´æ–°è‡³ 66 å€‹å¼±é»)  
**æ—¥æœŸ**: 2025-09-08  
**ç‹€æ…‹**: ğŸ”´ Critical - éœ€è¦ç«‹å³è™•ç†  

## ğŸ“Š ç¾ç‹€åˆ†æ (æ›´æ–°)

### CodeQL æƒæçµæœ
- **High é¢¨éšª**: 31é … (Client-side XSS + security-utils.js å•é¡Œ)
- **Medium é¢¨éšª**: 35é … (URL Redirect + DOM å•é¡Œ)
- **ç¸½è¨ˆ**: 66é …å®‰å…¨å¼±é»

### é—œéµå•é¡Œ
1. **security-utils.js åš´é‡æ¼æ´** - åŸºæ–¼ Regex çš„éæ¿¾å®¹æ˜“è¢«ç¹é
2. **ä¿®è£œç‹€æ…‹ä¸ä¸€è‡´** - è²ç¨±å·²ä¿®è£œä½†æƒæä»é¡¯ç¤ºå•é¡Œ
3. **éœ€è¦æ ¹æœ¬æ€§è§£æ±ºæ–¹æ¡ˆ** - DOMPurify å‡ç´š

### å½±éŸ¿æª”æ¡ˆ (æ“´å……)
```
â”œâ”€â”€ assets/security-utils.js (8è™•å¼±é») âš ï¸ æ ¸å¿ƒå•é¡Œ
â”œâ”€â”€ index.html (4è™• XSS + 1è™• URL)
â”œâ”€â”€ index1.html (5è™• XSS + 1è™• URL)
â”œâ”€â”€ index-en.html (4è™• XSS + 1è™• URL)
â”œâ”€â”€ index1-en.html (4è™• XSS + 1è™• URL)
â”œâ”€â”€ index-personal.html (4è™• URL Redirect)
â”œâ”€â”€ index-personal-en.html (4è™• URL Redirect)
â”œâ”€â”€ index1-bilingual.html (1è™• XSS + 1è™• URL Redirect)
â”œâ”€â”€ assets/bilingual-common.js (1è™• XSS + å¤šè™• URL Redirect)
â”œâ”€â”€ tests/test-social-links.html (1è™• DOM å•é¡Œ)
â”œâ”€â”€ tests/test-accessibility.html (1è™• DOM å•é¡Œ)
â””â”€â”€ nfc-generator-bilingual.html (1è™• DOM å•é¡Œ)
```

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹è¨­è¨ˆ (é‡æ–°è¨­è¨ˆ)

### 1. DOMPurify æ•´åˆæ¶æ§‹ (Critical)

```javascript
// æ–°çš„å®‰å…¨æ¶æ§‹ - ä½¿ç”¨ DOMPurify
const SecurityUtils = {
    // HTML æ¸…ç† - ä½¿ç”¨ DOMPurify
    sanitizeHTML: function(html) {
        if (typeof DOMPurify === 'undefined') {
            console.error('DOMPurify not loaded');
            return ''; // å®‰å…¨é™ç´š
        }
        
        return DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'span', 'br'],
            ALLOWED_ATTR: ['class'],
            KEEP_CONTENT: true,
            RETURN_DOM: false
        });
    },
    
    // è¼¸å…¥é©—è­‰ (ä¿æŒç¾æœ‰)
    validateInput: function(data, schema) {
        // ç¾æœ‰é‚è¼¯ä¿æŒä¸è®Š
    },
    
    // URLé©—è­‰ (åŠ å¼·)
    validateURL: function(url, allowedOrigins = []) {
        try {
            const urlObj = new URL(url);
            const allowedProtocols = ['http:', 'https:', 'mailto:', 'tel:'];
            
            if (!allowedProtocols.includes(urlObj.protocol)) {
                return false;
            }
            
            // æ–°å¢ï¼šOrigin ç™½åå–®æª¢æŸ¥
            if (allowedOrigins.length > 0 && ['http:', 'https:'].includes(urlObj.protocol)) {
                if (!allowedOrigins.includes(urlObj.origin)) {
                    this.logSecurityEvent('validateURL', 'Cross-origin URL blocked', { origin: urlObj.origin });
                    return false;
                }
            }
            
            return true;
        } catch (error) {
            return false;
        }
    }
};
```

### 2. ä¿®è£œç­–ç•¥ (æ›´æ–°)

#### Critical: DOMPurify å‡ç´š
- **å•é¡Œ**: security-utils.js åŸºæ–¼ Regex çš„éæ¿¾å­˜åœ¨åš´é‡æ¼æ´
- **è§£æ±º**: å®Œå…¨æ›¿æ›ç‚º DOMPurify ç™½åå–®æ©Ÿåˆ¶
- **å½±éŸ¿**: æ ¹æœ¬æ€§è§£æ±º HTML æ¸…ç†å•é¡Œ

#### High: Client-side XSS ä¿®è£œ (19é …)
- **å•é¡Œ**: `innerHTML` ç›´æ¥å¯«å…¥æœªé©—è­‰æ•¸æ“š
- **è§£æ±º**: å¼·åˆ¶ä½¿ç”¨ `SecurityUtils.sanitizeHTML()`
- **å½±éŸ¿**: 19å€‹æª”æ¡ˆä½ç½®éœ€è¦ä¿®æ”¹

#### High: security-utils.js æ ¸å¿ƒä¿®å¾© (8é …)
- **å•é¡Œ**: å¤šç¨® Regex éæ¿¾æ¼æ´
- **è§£æ±º**: DOMPurify æ•´åˆ + URL é©—è­‰é‚è¼¯ä¿®å¾©
- **å½±éŸ¿**: æ ¸å¿ƒå®‰å…¨æ¨¡çµ„é‡æ§‹

#### Medium: URL Redirect ä¿®è£œ (32é …)
- **å•é¡Œ**: ç¤¾ç¾¤é€£çµæœªé©—è­‰ç›´æ¥è·³è½‰
- **è§£æ±º**: Origin ç™½åå–® + `rel="noopener noreferrer"`
- **å½±éŸ¿**: æ‰€æœ‰ç¤¾ç¾¤é€£çµè™•ç†é‚è¼¯

### 3. DOMPurify æ•´åˆæ–¹æ¡ˆ

#### 3.1 å¼•å…¥æ–¹å¼
```html
<!-- æ–¹æ¡ˆ A: CDN å¼•å…¥ (æ¨è–¦) -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js" 
        integrity="sha384-FGosfzp4Si4ecU8GtH9UyKhbibWBr3GRYjNZZc2JbKy4FLdvRK9xZXyKzpKF8pGn" 
        crossorigin="anonymous"></script>

<!-- æ–¹æ¡ˆ B: æœ¬åœ°éƒ¨ç½² -->
<script src="assets/dompurify.min.js"></script>
```

#### 3.2 é…ç½®é¸é …
```javascript
// åŸºæœ¬é…ç½® (æ¨è–¦)
const basicConfig = {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'span', 'br'],
    ALLOWED_ATTR: ['class'],
    KEEP_CONTENT: true,
    RETURN_DOM: false
};

// é€²éšé…ç½® (å¦‚éœ€è¦)
const advancedConfig = {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'span', 'br', 'p', 'div'],
    ALLOWED_ATTR: ['class', 'id'],
    FORBID_TAGS: ['script', 'iframe', 'object', 'embed'],
    FORBID_ATTR: ['onerror', 'onload', 'onclick'],
    KEEP_CONTENT: true
};
```

#### 3.3 å®‰å…¨æ¸²æŸ“æ¨¡çµ„ (æ›´æ–°)
```javascript
// å®‰å…¨çš„DOMå…§å®¹è¨­å®š
function safeRender(element, content, allowHTML = false) {
    if (!element) {
        console.error('Element not found');
        return;
    }
    
    if (allowHTML) {
        // ä½¿ç”¨ DOMPurify æ¸…ç†
        element.innerHTML = SecurityUtils.sanitizeHTML(content);
    } else {
        // ç´”æ–‡å­—æ¨¡å¼
        element.textContent = content;
    }
    
    // è¨˜éŒ„å®‰å…¨äº‹ä»¶
    SecurityUtils.logSecurityEvent('safeRender', 'Content rendered', { 
        allowHTML, 
        contentLength: content.length 
    });
}
```

## ğŸ”’ Content Security Policy (æ›´æ–°)

### åŠ å¼·ç‰ˆ CSP æ¨™é ­
```html
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'none';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
">
```

### CSP é•è¦ç›£æ§
```javascript
// CSP é•è¦äº‹ä»¶ç›£è½
document.addEventListener('securitypolicyviolation', (e) => {
    SecurityUtils.logSecurityEvent('CSP_VIOLATION', 'CSP policy violated', {
        violatedDirective: e.violatedDirective,
        blockedURI: e.blockedURI,
        documentURI: e.documentURI
    });
});
```

## ğŸ“‹ å¯¦ä½œéšæ®µè¦åŠƒ (æ›´æ–°)

### Phase 0: ç·Šæ€¥ä¿®è£œ (Critical)
- **Task C1**: DOMPurify å‡ç´š (4-6å°æ™‚)
- **ç›®æ¨™**: è§£æ±º security-utils.js æ ¸å¿ƒæ¼æ´
- **é©—æ”¶**: æ‰€æœ‰ XSS æ¸¬è©¦é€šé

### Phase 1: High é¢¨éšªä¿®è£œ (24å°æ™‚å…§)
- **Task H1**: Client-side XSS ä¿®è£œ (19é …)
- **Task H2**: security-utils.js æ ¸å¿ƒä¿®å¾© (8é …)
- **Task H3**: CSP å¯¦æ–½
- **ç›®æ¨™**: è§£æ±ºæ‰€æœ‰ High é¢¨éšªå¼±é»

### Phase 2: Medium é¢¨éšªä¿®è£œ (ä¸€é€±å…§)
- **Task M1**: URL Redirect ä¿®è£œ (32é …)
- **Task M2**: DOM å•é¡Œä¿®è£œ (3é …)
- **ç›®æ¨™**: è§£æ±ºæ‰€æœ‰ Medium é¢¨éšªå¼±é»

### Phase 3: é©—è­‰èˆ‡å„ªåŒ–
- æ•´åˆæ¸¬è©¦
- æ•ˆèƒ½å„ªåŒ–
- CodeQL é‡æ–°æƒæ

## ğŸ§ª æ¸¬è©¦ç­–ç•¥ (æ“´å……)

### 1. DOMPurify å®‰å…¨æ¸¬è©¦
```javascript
// DOMPurify æ¸¬è©¦æ¡ˆä¾‹
const xssPayloads = [
    '<img src=x onerror=alert(1)>',
    '<svg onload=alert(1)>',
    '<script>alert("XSS")</script>',
    '<a href="javascript:alert(1)">Click</a>',
    '<details open ontoggle=alert(1)>',
    '<iframe src="javascript:alert(1)"></iframe>'
];

xssPayloads.forEach(payload => {
    const cleaned = DOMPurify.sanitize(payload);
    console.assert(!cleaned.includes('alert'), `Failed to sanitize: ${payload}`);
});
```

### 2. æ•´åˆæ¸¬è©¦ (æ›´æ–°)
- NFCæ•¸æ“šè§£ææµç¨‹æ¸¬è©¦
- å„é é¢æ¸²æŸ“å®‰å…¨æ€§æ¸¬è©¦
- è·¨ç€è¦½å™¨ç›¸å®¹æ€§æ¸¬è©¦
- DOMPurify è¼‰å…¥å¤±æ•—é™ç´šæ¸¬è©¦

### 3. å®‰å…¨æ¸¬è©¦ (æ“´å……)
- XSS payload æ¸¬è©¦é›† (50+ æ¸¬è©¦æ¡ˆä¾‹)
- æƒ¡æ„URLæ¸¬è©¦
- CSPé•è¦æª¢æ¸¬
- DOM Clobbering é˜²è­·æ¸¬è©¦

## ğŸ“ˆ æ•ˆèƒ½è€ƒé‡ (æ›´æ–°)

### DOMPurify æ•ˆèƒ½å½±éŸ¿
- **æª”æ¡ˆå¤§å°**: ~45KB (gzipped ~15KB)
- **è¼‰å…¥æ™‚é–“**: å¢åŠ ç´„ 50-100ms
- **æ¸…ç†æ•ˆèƒ½**: æ¯”è¤‡é›œ Regex æ›´å¿«
- **è¨˜æ†¶é«”ä½¿ç”¨**: è¼•é‡ç´šï¼Œç„¡æ˜é¡¯å½±éŸ¿

### æœ€å°åŒ–å½±éŸ¿ç­–ç•¥
- ä½¿ç”¨ CDN åŠ é€Ÿè¼‰å…¥
- å¯¦æ–½ SRI (Subresource Integrity) é©—è­‰
- ç›£æ§æ•ˆèƒ½æŒ‡æ¨™
- æº–å‚™é™ç´šæ–¹æ¡ˆ

## ğŸ”„ å‘ä¸‹ç›¸å®¹æ€§ä¿è­‰ (ä¿æŒ)

### ç¾æœ‰æ•¸æ“šæ ¼å¼æ”¯æ´ (ä¸è®Š)
- ç²¾ç°¡æ ¼å¼ï¼ˆv2.1.0+ï¼‰
- é›™èªç²¾ç°¡æ ¼å¼
- å®Œæ•´æ ¼å¼ï¼ˆv1.0+ï¼‰

### ç›¸å®¹æ€§è™•ç†æ©Ÿåˆ¶ (ä¸è®Š)
- ç¾æœ‰è½‰æ›å‡½æ•¸ä¿æŒä¸è®Š
- å®‰å…¨é©—è­‰ä½œç‚ºé™„åŠ å±¤
- éŒ¯èª¤æ™‚å„ªé›…é™ç´š

## ğŸ“Š é¢¨éšªè©•ä¼° (æ›´æ–°)

### Critical é¢¨éšª
- **DOMPurify æ•´åˆå¤±æ•—** - å¯èƒ½å°è‡´åŠŸèƒ½å®Œå…¨å¤±æ•ˆ
- **CDN ä¸å¯ç”¨** - éœ€è¦æœ¬åœ°å‚™ä»½æ–¹æ¡ˆ
- **ç›¸å®¹æ€§å•é¡Œ** - èˆŠç€è¦½å™¨æ”¯æ´

### ç·©è§£æªæ–½
- **é›™é‡ä¿éšœ**: CDN + æœ¬åœ°å‚™ä»½
- **æ¼¸é€²å¼éƒ¨ç½²**: åˆ†éšæ®µæ¸¬è©¦é©—è­‰
- **å›æ»¾æº–å‚™**: Git ç‰ˆæœ¬æ§åˆ¶
- **ç›£æ§æ©Ÿåˆ¶**: å¯¦æ™‚éŒ¯èª¤ç›£æ§

## ğŸ“ é©—æ”¶æ¨™æº– (æ›´æ–°)

### å®‰å…¨é©—æ”¶
- [ ] **CodeQL æƒæå¼±é»æ•¸ < 5** (ç›®æ¨™)
- [ ] DOMPurify æ•´åˆæˆåŠŸ
- [ ] æ‰€æœ‰ XSS æ¸¬è©¦é€šé
- [ ] CSP ç­–ç•¥ç”Ÿæ•ˆ
- [ ] URL é©—è­‰é‚è¼¯ä¿®å¾©

### åŠŸèƒ½é©—æ”¶
- [ ] æ‰€æœ‰ç¾æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œ
- [ ] NFCå¡ç‰‡è®€å–æˆåŠŸç‡100%
- [ ] é›™èªåˆ‡æ›ç„¡ç•°å¸¸
- [ ] æ•ˆèƒ½å½±éŸ¿ < 10%

### æŠ€è¡“é©—æ”¶
- [ ] DOMPurify æ­£ç¢ºè¼‰å…¥
- [ ] å®‰å…¨äº‹ä»¶æ—¥èªŒæ­£å¸¸
- [ ] éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ç”Ÿæ•ˆ
- [ ] é™ç´šæ–¹æ¡ˆå¯ç”¨

---
**æ¶æ§‹å¸«**: Amazon Q Developer CLI  
**å¯©æ ¸**: Gemini å°ˆå®¶å¯©æŸ¥  
**æœ€å¾Œæ›´æ–°**: 2025-09-08 19:50  
**ç·Šæ€¥ç‹€æ…‹**: ğŸ”´ ç«‹å³åŸ·è¡Œ DOMPurify å‡ç´š
