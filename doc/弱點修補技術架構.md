# 弱點修補技術架構

**專案**: NFC 數位名片系統安全修補  
**版本**: v2.0 (更新至 66 個弱點)  
**日期**: 2025-09-08  
**狀態**: 🔴 Critical - 需要立即處理  

## 📊 現狀分析 (更新)

### CodeQL 掃描結果
- **High 風險**: 31項 (Client-side XSS + security-utils.js 問題)
- **Medium 風險**: 35項 (URL Redirect + DOM 問題)
- **總計**: 66項安全弱點

### 關鍵問題
1. **security-utils.js 嚴重漏洞** - 基於 Regex 的過濾容易被繞過
2. **修補狀態不一致** - 聲稱已修補但掃描仍顯示問題
3. **需要根本性解決方案** - DOMPurify 升級

### 影響檔案 (擴充)
```
├── assets/security-utils.js (8處弱點) ⚠️ 核心問題
├── index.html (4處 XSS + 1處 URL)
├── index1.html (5處 XSS + 1處 URL)
├── index-en.html (4處 XSS + 1處 URL)
├── index1-en.html (4處 XSS + 1處 URL)
├── index-personal.html (4處 URL Redirect)
├── index-personal-en.html (4處 URL Redirect)
├── index1-bilingual.html (1處 XSS + 1處 URL Redirect)
├── assets/bilingual-common.js (1處 XSS + 多處 URL Redirect)
├── tests/test-social-links.html (1處 DOM 問題)
├── tests/test-accessibility.html (1處 DOM 問題)
└── nfc-generator-bilingual.html (1處 DOM 問題)
```

## 🏗️ 技術架構設計 (重新設計)

### 1. DOMPurify 整合架構 (Critical)

```javascript
// 新的安全架構 - 使用 DOMPurify
const SecurityUtils = {
    // HTML 清理 - 使用 DOMPurify
    sanitizeHTML: function(html) {
        if (typeof DOMPurify === 'undefined') {
            console.error('DOMPurify not loaded');
            return ''; // 安全降級
        }
        
        return DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'span', 'br'],
            ALLOWED_ATTR: ['class'],
            KEEP_CONTENT: true,
            RETURN_DOM: false
        });
    },
    
    // 輸入驗證 (保持現有)
    validateInput: function(data, schema) {
        // 現有邏輯保持不變
    },
    
    // URL驗證 (加強)
    validateURL: function(url, allowedOrigins = []) {
        try {
            const urlObj = new URL(url);
            const allowedProtocols = ['http:', 'https:', 'mailto:', 'tel:'];
            
            if (!allowedProtocols.includes(urlObj.protocol)) {
                return false;
            }
            
            // 新增：Origin 白名單檢查
            if (allowedOrigins.length > 0 && ['http:', 'https:'].includes(urlObj.protocol)) {
                if (!allowedOrigins.includes(urlObj.origin)) {
                    this.logSecurityEvent('validateURL', 'Cross-origin URL blocked', { origin: urlObj.origin });
                    return false;
                }
            }
            
            return true;
        } catch (error) {
            return false;
        }
    }
};
```

### 2. 修補策略 (更新)

#### Critical: DOMPurify 升級
- **問題**: security-utils.js 基於 Regex 的過濾存在嚴重漏洞
- **解決**: 完全替換為 DOMPurify 白名單機制
- **影響**: 根本性解決 HTML 清理問題

#### High: Client-side XSS 修補 (19項)
- **問題**: `innerHTML` 直接寫入未驗證數據
- **解決**: 強制使用 `SecurityUtils.sanitizeHTML()`
- **影響**: 19個檔案位置需要修改

#### High: security-utils.js 核心修復 (8項)
- **問題**: 多種 Regex 過濾漏洞
- **解決**: DOMPurify 整合 + URL 驗證邏輯修復
- **影響**: 核心安全模組重構

#### Medium: URL Redirect 修補 (32項)
- **問題**: 社群連結未驗證直接跳轉
- **解決**: Origin 白名單 + `rel="noopener noreferrer"`
- **影響**: 所有社群連結處理邏輯

### 3. DOMPurify 整合方案

#### 3.1 引入方式
```html
<!-- 方案 A: CDN 引入 (推薦) -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js" 
        integrity="sha384-FGosfzp4Si4ecU8GtH9UyKhbibWBr3GRYjNZZc2JbKy4FLdvRK9xZXyKzpKF8pGn" 
        crossorigin="anonymous"></script>

<!-- 方案 B: 本地部署 -->
<script src="assets/dompurify.min.js"></script>
```

#### 3.2 配置選項
```javascript
// 基本配置 (推薦)
const basicConfig = {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'span', 'br'],
    ALLOWED_ATTR: ['class'],
    KEEP_CONTENT: true,
    RETURN_DOM: false
};

// 進階配置 (如需要)
const advancedConfig = {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'span', 'br', 'p', 'div'],
    ALLOWED_ATTR: ['class', 'id'],
    FORBID_TAGS: ['script', 'iframe', 'object', 'embed'],
    FORBID_ATTR: ['onerror', 'onload', 'onclick'],
    KEEP_CONTENT: true
};
```

#### 3.3 安全渲染模組 (更新)
```javascript
// 安全的DOM內容設定
function safeRender(element, content, allowHTML = false) {
    if (!element) {
        console.error('Element not found');
        return;
    }
    
    if (allowHTML) {
        // 使用 DOMPurify 清理
        element.innerHTML = SecurityUtils.sanitizeHTML(content);
    } else {
        // 純文字模式
        element.textContent = content;
    }
    
    // 記錄安全事件
    SecurityUtils.logSecurityEvent('safeRender', 'Content rendered', { 
        allowHTML, 
        contentLength: content.length 
    });
}
```

## 🔒 Content Security Policy (更新)

### 加強版 CSP 標頭
```html
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'none';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
">
```

### CSP 違規監控
```javascript
// CSP 違規事件監聽
document.addEventListener('securitypolicyviolation', (e) => {
    SecurityUtils.logSecurityEvent('CSP_VIOLATION', 'CSP policy violated', {
        violatedDirective: e.violatedDirective,
        blockedURI: e.blockedURI,
        documentURI: e.documentURI
    });
});
```

## 📋 實作階段規劃 (更新)

### Phase 0: 緊急修補 (Critical)
- **Task C1**: DOMPurify 升級 (4-6小時)
- **目標**: 解決 security-utils.js 核心漏洞
- **驗收**: 所有 XSS 測試通過

### Phase 1: High 風險修補 (24小時內)
- **Task H1**: Client-side XSS 修補 (19項)
- **Task H2**: security-utils.js 核心修復 (8項)
- **Task H3**: CSP 實施
- **目標**: 解決所有 High 風險弱點

### Phase 2: Medium 風險修補 (一週內)
- **Task M1**: URL Redirect 修補 (32項)
- **Task M2**: DOM 問題修補 (3項)
- **目標**: 解決所有 Medium 風險弱點

### Phase 3: 驗證與優化
- 整合測試
- 效能優化
- CodeQL 重新掃描

## 🧪 測試策略 (擴充)

### 1. DOMPurify 安全測試
```javascript
// DOMPurify 測試案例
const xssPayloads = [
    '<img src=x onerror=alert(1)>',
    '<svg onload=alert(1)>',
    '<script>alert("XSS")</script>',
    '<a href="javascript:alert(1)">Click</a>',
    '<details open ontoggle=alert(1)>',
    '<iframe src="javascript:alert(1)"></iframe>'
];

xssPayloads.forEach(payload => {
    const cleaned = DOMPurify.sanitize(payload);
    console.assert(!cleaned.includes('alert'), `Failed to sanitize: ${payload}`);
});
```

### 2. 整合測試 (更新)
- NFC數據解析流程測試
- 各頁面渲染安全性測試
- 跨瀏覽器相容性測試
- DOMPurify 載入失敗降級測試

### 3. 安全測試 (擴充)
- XSS payload 測試集 (50+ 測試案例)
- 惡意URL測試
- CSP違規檢測
- DOM Clobbering 防護測試

## 📈 效能考量 (更新)

### DOMPurify 效能影響
- **檔案大小**: ~45KB (gzipped ~15KB)
- **載入時間**: 增加約 50-100ms
- **清理效能**: 比複雜 Regex 更快
- **記憶體使用**: 輕量級，無明顯影響

### 最小化影響策略
- 使用 CDN 加速載入
- 實施 SRI (Subresource Integrity) 驗證
- 監控效能指標
- 準備降級方案

## 🔄 向下相容性保證 (保持)

### 現有數據格式支援 (不變)
- 精簡格式（v2.1.0+）
- 雙語精簡格式
- 完整格式（v1.0+）

### 相容性處理機制 (不變)
- 現有轉換函數保持不變
- 安全驗證作為附加層
- 錯誤時優雅降級

## 📊 風險評估 (更新)

### Critical 風險
- **DOMPurify 整合失敗** - 可能導致功能完全失效
- **CDN 不可用** - 需要本地備份方案
- **相容性問題** - 舊瀏覽器支援

### 緩解措施
- **雙重保障**: CDN + 本地備份
- **漸進式部署**: 分階段測試驗證
- **回滾準備**: Git 版本控制
- **監控機制**: 實時錯誤監控

## 📝 驗收標準 (更新)

### 安全驗收
- [ ] **CodeQL 掃描弱點數 < 5** (目標)
- [ ] DOMPurify 整合成功
- [ ] 所有 XSS 測試通過
- [ ] CSP 策略生效
- [ ] URL 驗證邏輯修復

### 功能驗收
- [ ] 所有現有功能正常運作
- [ ] NFC卡片讀取成功率100%
- [ ] 雙語切換無異常
- [ ] 效能影響 < 10%

### 技術驗收
- [ ] DOMPurify 正確載入
- [ ] 安全事件日誌正常
- [ ] 錯誤處理機制生效
- [ ] 降級方案可用

---
**架構師**: Amazon Q Developer CLI  
**審核**: Gemini 專家審查  
**最後更新**: 2025-09-08 19:50  
**緊急狀態**: 🔴 立即執行 DOMPurify 升級
