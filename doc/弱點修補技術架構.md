# å¼±é»ä¿®è£œæŠ€è¡“æ¶æ§‹

**å°ˆæ¡ˆ**: NFC æ•¸ä½åç‰‡ç³»çµ±å®‰å…¨ä¿®è£œ  
**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2025-09-08

## ğŸ“Š ç¾ç‹€åˆ†æ

### å¼±é»åˆ†å¸ƒ
- **DOM XSS**: 30é … (Medium) - 6å€‹HTMLæª”æ¡ˆï¼Œæ¯æª”æ¡ˆ5è™•
- **Open Redirect**: 1é … (Medium) - bilingual-common.js

### å½±éŸ¿æª”æ¡ˆ
```
â”œâ”€â”€ index.html (5è™•å¼±é»)
â”œâ”€â”€ index1.html (5è™•å¼±é»)  
â”œâ”€â”€ index-en.html (5è™•å¼±é»)
â”œâ”€â”€ index1-en.html (5è™•å¼±é»)
â”œâ”€â”€ index-personal.html (5è™•å¼±é»)
â”œâ”€â”€ index-personal-en.html (5è™•å¼±é»)
â””â”€â”€ assets/bilingual-common.js (1è™•å¼±é»)
```

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹è¨­è¨ˆ

### 1. çµ±ä¸€å®‰å…¨æ¨¡çµ„ (security-utils.js)

```javascript
// æ ¸å¿ƒå®‰å…¨å‡½æ•¸åº«
const SecurityUtils = {
    // è¼¸å…¥é©—è­‰
    validateInput(data, schema),
    
    // å®‰å…¨æ¸²æŸ“
    safeRender(element, content),
    
    // URLé©—è­‰
    validateURL(url, whitelist),
    
    // Base64/JSONå®‰å…¨è§£ç¢¼
    safeDecodeData(encodedData)
};
```

### 2. ä¿®è£œç­–ç•¥

#### DOM XSS ä¿®è£œ
- **å•é¡Œ**: `innerHTML` ç›´æ¥å¯«å…¥æœªé©—è­‰æ•¸æ“š
- **è§£æ±º**: ä½¿ç”¨ `textContent` + çµæ§‹åŒ–é©—è­‰
- **å½±éŸ¿**: 6å€‹HTMLæª”æ¡ˆï¼Œ30è™•ä¿®æ”¹é»

#### Open Redirect ä¿®è£œ  
- **å•é¡Œ**: ç¤¾ç¾¤é€£çµæœªé©—è­‰ç›´æ¥è·³è½‰
- **è§£æ±º**: URLç™½åå–® + `rel="noopener noreferrer"`
- **å½±éŸ¿**: bilingual-common.js 1è™•ä¿®æ”¹é»

### 3. å®‰å…¨æ¨¡çµ„ API è¨­è¨ˆ

#### 3.1 è¼¸å…¥é©—è­‰æ¨¡çµ„ï¼ˆç›¸å®¹æ€§å„ªå…ˆï¼‰
```javascript
// é©—è­‰NFCæ•¸æ“šæ ¼å¼ï¼ˆæ”¯æ´å¤šç‰ˆæœ¬æ ¼å¼ï¼‰
function validateNFCData(data) {
    // æª¢æ¸¬æ•¸æ“šæ ¼å¼ç‰ˆæœ¬
    const isCompactFormat = hasCompactKeys(data);
    
    if (isCompactFormat) {
        // ç²¾ç°¡æ ¼å¼é©—è­‰ï¼ˆå–®å­—æ¯éµå€¼å°ï¼‰
        const compactSchema = {
            n: { type: 'string', maxLength: 50, bilingual: true },    // name
            t: { type: 'string', maxLength: 100, bilingual: true },   // title
            d: { type: 'string', maxLength: 100 },   // department
            e: { type: 'email', optional: true },    // email
            p: { type: 'phone', optional: true },    // phone
            m: { type: 'phone', optional: true },    // mobile
            a: { type: 'url', optional: true },      // avatar
            g: { type: 'array', optional: true, bilingual: true },    // greetings
            s: { type: 'string', optional: true }    // socialNote
        };
        return SecurityUtils.validateInput(data, compactSchema);
    } else {
        // å®Œæ•´æ ¼å¼é©—è­‰
        const fullSchema = {
            name: { type: 'string', maxLength: 50 },
            title: { type: 'string', maxLength: 100 },
            email: { type: 'email', optional: true },
            // ...å…¶ä»–æ¬„ä½
        };
        return SecurityUtils.validateInput(data.data || data, fullSchema);
    }
}

// æª¢æ¸¬æ˜¯å¦ç‚ºç²¾ç°¡æ ¼å¼
function hasCompactKeys(data) {
    const compactKeys = ['n', 't', 'd', 'e', 'p', 'm', 'a', 'g', 's'];
    const dataKeys = Object.keys(data);
    return compactKeys.some(key => dataKeys.includes(key));
}

// é›™èªå…§å®¹é©—è­‰
function validateBilingualContent(value, maxLength) {
    if (!value) return true;
    
    if (value.includes('~')) {
        const [zh, en] = value.split('~').map(s => s.trim());
        return (zh.length <= maxLength) && (en.length <= maxLength);
    }
    
    return value.length <= maxLength;
}
```

#### 3.2 å®‰å…¨æ¸²æŸ“æ¨¡çµ„
```javascript
// å®‰å…¨çš„DOMå…§å®¹è¨­å®š
function safeSetContent(elementId, content, type = 'text') {
    const element = document.getElementById(elementId);
    if (type === 'text') {
        element.textContent = content;
    } else if (type === 'html') {
        element.innerHTML = SecurityUtils.sanitizeHTML(content);
    }
}
```

#### 3.3 URLé©—è­‰æ¨¡çµ„ï¼ˆé›™èªç‰ˆå¢å¼·ï¼‰
```javascript
// ç¤¾ç¾¤é€£çµç™½åå–®é©—è­‰ï¼ˆæ”¯æ´é›™èªç‰ˆï¼‰
function validateSocialURL(url) {
    const whitelist = [
        /^https:\/\/(www\.)?facebook\.com\//,
        /^https:\/\/(www\.)?fb\.com\//,
        /^https:\/\/(www\.)?instagram\.com\//,
        /^https:\/\/line\.me\//,
        /^https:\/\/(www\.)?github\.com\//,
        /^https:\/\/(www\.)?twitter\.com\//,
        /^https:\/\/(www\.)?x\.com\//,
        /^https:\/\/(www\.)?linkedin\.com\//,
        /^https:\/\/(www\.)?youtube\.com\//,
        /^https:\/\/(www\.)?discord\.gg\//,
        /^mailto:/
    ];
    return whitelist.some(pattern => pattern.test(url));
}

// å®‰å…¨çš„ç¤¾ç¾¤é€£çµå‰µå»ºï¼ˆbilingual-common.js å°ˆç”¨ï¼‰
function createSecureSocialElement(platform, url, buttonText, brandColor, displayUrl = null) {
    // URL é©—è­‰
    if (!validateSocialURL(url)) {
        console.warn('Blocked potentially malicious URL:', url);
        return null;
    }
    
    // å‰µå»ºå®‰å…¨çš„é€£çµå…ƒç´ 
    const link = document.createElement('a');
    link.href = url;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';  // å®‰å…¨å±¬æ€§
    link.className = 'social-link';
    link.style.cssText = `background: ${brandColor}; color: white; padding: 4px 12px; border-radius: 16px; text-decoration: none; font-size: 0.85em; font-weight: 500;`;
    link.textContent = buttonText;
    
    return link;
}
```

## ğŸ”’ Content Security Policy

### CSP æ¨™é ­é…ç½®
```html
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline' fonts.googleapis.com;
    font-src fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'none';
">
```

## ğŸ“‹ å¯¦ä½œéšæ®µè¦åŠƒ

### Phase 1: åŸºç¤è¨­æ–½ (P0)
- å‰µå»º `assets/security-utils.js`
- å¯¦ä½œæ ¸å¿ƒå®‰å…¨å‡½æ•¸
- å–®å…ƒæ¸¬è©¦è¦†è“‹

### Phase 2: DOM XSS ä¿®è£œ (P1)  
- ä¿®è£œ6å€‹HTMLæª”æ¡ˆ
- æ›¿æ› `innerHTML` ç‚ºå®‰å…¨æ¸²æŸ“
- æ·»åŠ è¼¸å…¥é©—è­‰

### Phase 3: Open Redirect ä¿®è£œ (P2)
- ä¿®è£œ `bilingual-common.js`
- å¯¦ä½œURLç™½åå–®é©—è­‰
- æ·»åŠ å®‰å…¨å±¬æ€§

### Phase 4: å®‰å…¨å¼·åŒ– (P3)
- æ·»åŠ CSPæ¨™é ­
- å¯¦ä½œéŒ¯èª¤è™•ç†
- å®‰å…¨æ—¥èªŒè¨˜éŒ„

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### 1. å–®å…ƒæ¸¬è©¦
```javascript
// å®‰å…¨å‡½æ•¸æ¸¬è©¦
describe('SecurityUtils', () => {
    test('validateInput should reject XSS payload', () => {
        const malicious = '<script>alert("xss")</script>';
        expect(SecurityUtils.validateInput(malicious)).toBe(false);
    });
});
```

### 2. æ•´åˆæ¸¬è©¦
- NFCæ•¸æ“šè§£ææµç¨‹æ¸¬è©¦
- å„é é¢æ¸²æŸ“å®‰å…¨æ€§æ¸¬è©¦
- è·¨ç€è¦½å™¨ç›¸å®¹æ€§æ¸¬è©¦

### 3. å®‰å…¨æ¸¬è©¦
- XSS payload æ¸¬è©¦é›†
- æƒ¡æ„URLæ¸¬è©¦
- CSPé•è¦æª¢æ¸¬

## ğŸ“ˆ æ•ˆèƒ½è€ƒé‡

### æœ€å°åŒ–å½±éŸ¿
- å®‰å…¨é©—è­‰åƒ…åœ¨æ•¸æ“šè¼‰å…¥æ™‚åŸ·è¡Œ
- ä½¿ç”¨å¿«å–æ¸›å°‘é‡è¤‡é©—è­‰
- ä¿æŒåŸæœ‰æ¸²æŸ“æ•ˆèƒ½

### è¼‰å…¥å„ªåŒ–
- å®‰å…¨æ¨¡çµ„æŒ‰éœ€è¼‰å…¥
- å£“ç¸®å¾Œç´„2KBå¢é‡
- ä¸å½±éŸ¿NFCè®€å–é€Ÿåº¦

## ğŸ”„ å‘ä¸‹ç›¸å®¹æ€§ä¿è­‰

### ç¾æœ‰æ•¸æ“šæ ¼å¼æ”¯æ´

å°ˆæ¡ˆå·²æ”¯æ´å¤šç¨® NFC æ•¸æ“šæ ¼å¼ï¼ŒåŒ…å«é›™èªç‰ˆæœ¬ï¼š

#### 1. ç²¾ç°¡æ ¼å¼ï¼ˆv2.1.0+ï¼‰
```javascript
// å–®å­—æ¯éµå€¼å°ï¼Œç¯€çœ NFC å®¹é‡
{
    "n": "å§“å",           // name
    "t": "è·ç¨±",           // title  
    "d": "éƒ¨é–€",           // department
    "e": "email@gov.tw",   // email
    "p": "02-12345678",    // phone
    "m": "0912345678",     // mobile (v2.1.0æ–°å¢)
    "a": "avatar_url",     // avatar
    "g": ["å•å€™èª"],       // greetings
    "s": "ç¤¾ç¾¤é€£çµ"        // socialNote
}
```

#### 2. é›™èªç²¾ç°¡æ ¼å¼ï¼ˆbilingual-common.jsï¼‰
```javascript
// ä½¿ç”¨ ~ åˆ†éš”ç¬¦çš„é›™èªæ ¼å¼
{
    "n": "ç‹å°æ˜~John Wang",
    "t": "è³‡æ·±å·¥ç¨‹å¸«~Senior Engineer", 
    "d": "è³‡è¨Šè™•",  // éƒ¨é–€ä½¿ç”¨ç¿»è­¯å­—å…¸
    "g": ["å¾ˆé«˜èˆˆèªè­˜æ‚¨ï¼~Nice to meet you!", "æ­¡è¿äº¤æµ~Welcome to connect"]
}
```

#### 3. å®Œæ•´æ ¼å¼ï¼ˆv1.0+ï¼‰
```javascript
// å®Œæ•´æ¬„ä½åç¨±
{
    "data": {
        "name": "å§“å",
        "title": "è·ç¨±",
        "department": "éƒ¨é–€",
        // ...å®Œæ•´æ¬„ä½
    }
}
```

### ç›¸å®¹æ€§è™•ç†æ©Ÿåˆ¶

#### ç¾æœ‰è½‰æ›å‡½æ•¸ï¼ˆä¿æŒä¸è®Šï¼‰

**1. å–®èªç‰ˆè½‰æ›å‡½æ•¸**
```javascript
// ç¾æœ‰çš„ convertCompactToFull å‡½æ•¸å¿…é ˆä¿æŒ
function convertCompactToFull(compactData) {
    return {
        data: {
            name: compactData.n || '',
            title: compactData.t || '',
            department: compactData.d || '',
            organization: 'æ•¸ä½ç™¼å±•éƒ¨',
            email: compactData.e || '',
            phone: compactData.p || '',
            mobile: compactData.m || '',
            avatar: compactData.a || '',
            address: '100057è‡ºåŒ—å¸‚ä¸­æ­£å€å»¶å¹³å—è·¯143è™Ÿ',
            greetings: compactData.g || ['æ­¡è¿èªè­˜æˆ‘ï¼'],
            socialLinks: {
                email: compactData.e ? `mailto:${compactData.e}` : '',
                socialNote: compactData.s || ''
            }
        }
    };
}
```

**2. é›™èªç‰ˆè§£ç¢¼å‡½æ•¸ï¼ˆbilingual-common.jsï¼‰**
```javascript
// ç¾æœ‰çš„ decodeCompact å‡½æ•¸å¿…é ˆä¿æŒ
function decodeCompact(encoded) {
    try {
        const padding = '='.repeat((4 - encoded.length % 4) % 4);
        const compact = decodeURIComponent(atob(
            encoded.replace(/-/g, '+').replace(/_/g, '/') + padding
        ));
        
        const parts = compact.split('|');
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºèˆŠç‰ˆæœ¬æ ¼å¼ï¼ˆ8å€‹æ¬„ä½ï¼Œæ²’æœ‰æ‰‹æ©Ÿè™Ÿç¢¼ï¼‰
        if (parts.length === 8) {
            return {
                name: parts[0] || '',
                title: parts[1] || '',
                department: parts[2] || '',
                email: parts[3] || '',
                phone: parts[4] || '',
                mobile: '', // èˆŠç‰ˆæœ¬æ²’æœ‰æ‰‹æ©Ÿè™Ÿç¢¼
                avatar: parts[5] || '',
                greetings: parts[6] ? parts[6].split(',') : [],
                socialNote: parts[7] || ''
            };
        }
        
        // æ–°ç‰ˆæœ¬æ ¼å¼ï¼ˆ9å€‹æ¬„ä½ï¼ŒåŒ…å«æ‰‹æ©Ÿè™Ÿç¢¼ï¼‰
        return { /* å®Œæ•´æ ¼å¼ */ };
    } catch (error) {
        console.error('è§£ç¢¼å¤±æ•—:', error);
        return null;
    }
}
```

**3. é›™èªè§£æå‡½æ•¸**
```javascript
// ç¾æœ‰çš„ parseBilingual å‡½æ•¸å¿…é ˆä¿æŒ
function parseBilingual(value) {
    if (!value) return { zh: '', en: '' };
    
    if (value.includes('~')) {
        const [zh, en] = value.split('~').map(s => s.trim());
        return { zh: zh || '', en: en || '' };
    }
    
    return { zh: value, en: value };
}
```

### å®‰å…¨ä¿®è£œç­–ç•¥

#### 1. é©—è­‰å‰æ ¼å¼æª¢æ¸¬
- è‡ªå‹•è­˜åˆ¥ç²¾ç°¡æ ¼å¼ vs å®Œæ•´æ ¼å¼
- ä½¿ç”¨å°æ‡‰çš„é©—è­‰è¦å‰‡
- ä¿æŒåŸæœ‰è½‰æ›é‚è¼¯

#### 2. æ¼¸é€²å¼å®‰å…¨å¢å¼·
- å®‰å…¨é©—è­‰ä½œç‚ºé™„åŠ å±¤
- ä¸ä¿®æ”¹æ ¸å¿ƒè½‰æ›é‚è¼¯
- éŒ¯èª¤æ™‚å„ªé›…é™ç´š

#### 3. æ¸¬è©¦è¦†è“‹
- èˆŠæ ¼å¼ NFC å¡ç‰‡æ¸¬è©¦
- æ–°æ ¼å¼ç›¸å®¹æ€§æ¸¬è©¦
- æ ¼å¼è½‰æ›æ­£ç¢ºæ€§æ¸¬è©¦

## ğŸ“Š é¢¨éšªè©•ä¼°

### å¯¦ä½œé¢¨éšª
- **ä½é¢¨éšª**: å®‰å…¨æ¨¡çµ„ç¨ç«‹ï¼Œä¸å½±éŸ¿æ ¸å¿ƒé‚è¼¯
- **ä¸­é¢¨éšª**: DOMæ“ä½œè®Šæ›´å¯èƒ½å½±éŸ¿æ¨£å¼
- **ç·©è§£**: å……åˆ†æ¸¬è©¦ï¼Œåˆ†éšæ®µéƒ¨ç½²

### æ•ˆèƒ½é¢¨éšª  
- **ä½é¢¨éšª**: å®‰å…¨é©—è­‰é–‹éŠ·æœ€å°
- **ç·©è§£**: æ•ˆèƒ½ç›£æ§ï¼Œå„ªåŒ–é—œéµè·¯å¾‘

## ğŸ“ é©—æ”¶æ¨™æº–

### åŠŸèƒ½é©—æ”¶
- [ ] æ‰€æœ‰ç¾æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œ
- [ ] NFCå¡ç‰‡è®€å–æˆåŠŸç‡100%
- [ ] é›™èªåˆ‡æ›ç„¡ç•°å¸¸

### å®‰å…¨é©—æ”¶
- [ ] XSSæ¸¬è©¦é›†é€šéç‡100%
- [ ] URLé©—è­‰è¦†è“‹ç‡100%
- [ ] CSPé•è¦é›¶å®¹å¿

### æ•ˆèƒ½é©—æ”¶
- [ ] é é¢è¼‰å…¥æ™‚é–“å¢åŠ <10%
- [ ] è¨˜æ†¶é«”ä½¿ç”¨å¢åŠ <5%
- [ ] å®‰å…¨é©—è­‰è€—æ™‚<1ms

---
**æ¶æ§‹å¸«**: Amazon Q Developer CLI  
**å¯©æ ¸**: å¾…å®š  
**æœ€å¾Œæ›´æ–°**: 2025-09-08
