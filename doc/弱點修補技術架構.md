# 弱點修補技術架構

**專案**: NFC 數位名片系統安全修補  
**版本**: v1.0  
**日期**: 2025-09-08

## 📊 現狀分析

### 弱點分布
- **DOM XSS**: 30項 (Medium) - 6個HTML檔案，每檔案5處
- **Open Redirect**: 1項 (Medium) - bilingual-common.js

### 影響檔案
```
├── index.html (5處弱點)
├── index1.html (5處弱點)  
├── index-en.html (5處弱點)
├── index1-en.html (5處弱點)
├── index-personal.html (5處弱點)
├── index-personal-en.html (5處弱點)
└── assets/bilingual-common.js (1處弱點)
```

## 🏗️ 技術架構設計

### 1. 統一安全模組 (security-utils.js)

```javascript
// 核心安全函數庫
const SecurityUtils = {
    // 輸入驗證
    validateInput(data, schema),
    
    // 安全渲染
    safeRender(element, content),
    
    // URL驗證
    validateURL(url, whitelist),
    
    // Base64/JSON安全解碼
    safeDecodeData(encodedData)
};
```

### 2. 修補策略

#### DOM XSS 修補
- **問題**: `innerHTML` 直接寫入未驗證數據
- **解決**: 使用 `textContent` + 結構化驗證
- **影響**: 6個HTML檔案，30處修改點

#### Open Redirect 修補  
- **問題**: 社群連結未驗證直接跳轉
- **解決**: URL白名單 + `rel="noopener noreferrer"`
- **影響**: bilingual-common.js 1處修改點

### 3. 安全模組 API 設計

#### 3.1 輸入驗證模組（相容性優先）
```javascript
// 驗證NFC數據格式（支援多版本格式）
function validateNFCData(data) {
    // 檢測數據格式版本
    const isCompactFormat = hasCompactKeys(data);
    
    if (isCompactFormat) {
        // 精簡格式驗證（單字母鍵值對）
        const compactSchema = {
            n: { type: 'string', maxLength: 50, bilingual: true },    // name
            t: { type: 'string', maxLength: 100, bilingual: true },   // title
            d: { type: 'string', maxLength: 100 },   // department
            e: { type: 'email', optional: true },    // email
            p: { type: 'phone', optional: true },    // phone
            m: { type: 'phone', optional: true },    // mobile
            a: { type: 'url', optional: true },      // avatar
            g: { type: 'array', optional: true, bilingual: true },    // greetings
            s: { type: 'string', optional: true }    // socialNote
        };
        return SecurityUtils.validateInput(data, compactSchema);
    } else {
        // 完整格式驗證
        const fullSchema = {
            name: { type: 'string', maxLength: 50 },
            title: { type: 'string', maxLength: 100 },
            email: { type: 'email', optional: true },
            // ...其他欄位
        };
        return SecurityUtils.validateInput(data.data || data, fullSchema);
    }
}

// 檢測是否為精簡格式
function hasCompactKeys(data) {
    const compactKeys = ['n', 't', 'd', 'e', 'p', 'm', 'a', 'g', 's'];
    const dataKeys = Object.keys(data);
    return compactKeys.some(key => dataKeys.includes(key));
}

// 雙語內容驗證
function validateBilingualContent(value, maxLength) {
    if (!value) return true;
    
    if (value.includes('~')) {
        const [zh, en] = value.split('~').map(s => s.trim());
        return (zh.length <= maxLength) && (en.length <= maxLength);
    }
    
    return value.length <= maxLength;
}
```

#### 3.2 安全渲染模組
```javascript
// 安全的DOM內容設定
function safeSetContent(elementId, content, type = 'text') {
    const element = document.getElementById(elementId);
    if (type === 'text') {
        element.textContent = content;
    } else if (type === 'html') {
        element.innerHTML = SecurityUtils.sanitizeHTML(content);
    }
}
```

#### 3.3 URL驗證模組（雙語版增強）
```javascript
// 社群連結白名單驗證（支援雙語版）
function validateSocialURL(url) {
    const whitelist = [
        /^https:\/\/(www\.)?facebook\.com\//,
        /^https:\/\/(www\.)?fb\.com\//,
        /^https:\/\/(www\.)?instagram\.com\//,
        /^https:\/\/line\.me\//,
        /^https:\/\/(www\.)?github\.com\//,
        /^https:\/\/(www\.)?twitter\.com\//,
        /^https:\/\/(www\.)?x\.com\//,
        /^https:\/\/(www\.)?linkedin\.com\//,
        /^https:\/\/(www\.)?youtube\.com\//,
        /^https:\/\/(www\.)?discord\.gg\//,
        /^mailto:/
    ];
    return whitelist.some(pattern => pattern.test(url));
}

// 安全的社群連結創建（bilingual-common.js 專用）
function createSecureSocialElement(platform, url, buttonText, brandColor, displayUrl = null) {
    // URL 驗證
    if (!validateSocialURL(url)) {
        console.warn('Blocked potentially malicious URL:', url);
        return null;
    }
    
    // 創建安全的連結元素
    const link = document.createElement('a');
    link.href = url;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';  // 安全屬性
    link.className = 'social-link';
    link.style.cssText = `background: ${brandColor}; color: white; padding: 4px 12px; border-radius: 16px; text-decoration: none; font-size: 0.85em; font-weight: 500;`;
    link.textContent = buttonText;
    
    return link;
}
```

## 🔒 Content Security Policy

### CSP 標頭配置
```html
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline' fonts.googleapis.com;
    font-src fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'none';
">
```

## 📋 實作階段規劃

### Phase 1: 基礎設施 (P0)
- 創建 `assets/security-utils.js`
- 實作核心安全函數
- 單元測試覆蓋

### Phase 2: DOM XSS 修補 (P1)  
- 修補6個HTML檔案
- 替換 `innerHTML` 為安全渲染
- 添加輸入驗證

### Phase 3: Open Redirect 修補 (P2)
- 修補 `bilingual-common.js`
- 實作URL白名單驗證
- 添加安全屬性

### Phase 4: 安全強化 (P3)
- 添加CSP標頭
- 實作錯誤處理
- 安全日誌記錄

## 🧪 測試策略

### 1. 單元測試
```javascript
// 安全函數測試
describe('SecurityUtils', () => {
    test('validateInput should reject XSS payload', () => {
        const malicious = '<script>alert("xss")</script>';
        expect(SecurityUtils.validateInput(malicious)).toBe(false);
    });
});
```

### 2. 整合測試
- NFC數據解析流程測試
- 各頁面渲染安全性測試
- 跨瀏覽器相容性測試

### 3. 安全測試
- XSS payload 測試集
- 惡意URL測試
- CSP違規檢測

## 📈 效能考量

### 最小化影響
- 安全驗證僅在數據載入時執行
- 使用快取減少重複驗證
- 保持原有渲染效能

### 載入優化
- 安全模組按需載入
- 壓縮後約2KB增量
- 不影響NFC讀取速度

## 🔄 向下相容性保證

### 現有數據格式支援

專案已支援多種 NFC 數據格式，包含雙語版本：

#### 1. 精簡格式（v2.1.0+）
```javascript
// 單字母鍵值對，節省 NFC 容量
{
    "n": "姓名",           // name
    "t": "職稱",           // title  
    "d": "部門",           // department
    "e": "email@gov.tw",   // email
    "p": "02-12345678",    // phone
    "m": "0912345678",     // mobile (v2.1.0新增)
    "a": "avatar_url",     // avatar
    "g": ["問候語"],       // greetings
    "s": "社群連結"        // socialNote
}
```

#### 2. 雙語精簡格式（bilingual-common.js）
```javascript
// 使用 ~ 分隔符的雙語格式
{
    "n": "王小明~John Wang",
    "t": "資深工程師~Senior Engineer", 
    "d": "資訊處",  // 部門使用翻譯字典
    "g": ["很高興認識您！~Nice to meet you!", "歡迎交流~Welcome to connect"]
}
```

#### 3. 完整格式（v1.0+）
```javascript
// 完整欄位名稱
{
    "data": {
        "name": "姓名",
        "title": "職稱",
        "department": "部門",
        // ...完整欄位
    }
}
```

### 相容性處理機制

#### 現有轉換函數（保持不變）

**1. 單語版轉換函數**
```javascript
// 現有的 convertCompactToFull 函數必須保持
function convertCompactToFull(compactData) {
    return {
        data: {
            name: compactData.n || '',
            title: compactData.t || '',
            department: compactData.d || '',
            organization: '數位發展部',
            email: compactData.e || '',
            phone: compactData.p || '',
            mobile: compactData.m || '',
            avatar: compactData.a || '',
            address: '100057臺北市中正區延平南路143號',
            greetings: compactData.g || ['歡迎認識我！'],
            socialLinks: {
                email: compactData.e ? `mailto:${compactData.e}` : '',
                socialNote: compactData.s || ''
            }
        }
    };
}
```

**2. 雙語版解碼函數（bilingual-common.js）**
```javascript
// 現有的 decodeCompact 函數必須保持
function decodeCompact(encoded) {
    try {
        const padding = '='.repeat((4 - encoded.length % 4) % 4);
        const compact = decodeURIComponent(atob(
            encoded.replace(/-/g, '+').replace(/_/g, '/') + padding
        ));
        
        const parts = compact.split('|');
        
        // 檢查是否為舊版本格式（8個欄位，沒有手機號碼）
        if (parts.length === 8) {
            return {
                name: parts[0] || '',
                title: parts[1] || '',
                department: parts[2] || '',
                email: parts[3] || '',
                phone: parts[4] || '',
                mobile: '', // 舊版本沒有手機號碼
                avatar: parts[5] || '',
                greetings: parts[6] ? parts[6].split(',') : [],
                socialNote: parts[7] || ''
            };
        }
        
        // 新版本格式（9個欄位，包含手機號碼）
        return { /* 完整格式 */ };
    } catch (error) {
        console.error('解碼失敗:', error);
        return null;
    }
}
```

**3. 雙語解析函數**
```javascript
// 現有的 parseBilingual 函數必須保持
function parseBilingual(value) {
    if (!value) return { zh: '', en: '' };
    
    if (value.includes('~')) {
        const [zh, en] = value.split('~').map(s => s.trim());
        return { zh: zh || '', en: en || '' };
    }
    
    return { zh: value, en: value };
}
```

### 安全修補策略

#### 1. 驗證前格式檢測
- 自動識別精簡格式 vs 完整格式
- 使用對應的驗證規則
- 保持原有轉換邏輯

#### 2. 漸進式安全增強
- 安全驗證作為附加層
- 不修改核心轉換邏輯
- 錯誤時優雅降級

#### 3. 測試覆蓋
- 舊格式 NFC 卡片測試
- 新格式相容性測試
- 格式轉換正確性測試

## 📊 風險評估

### 實作風險
- **低風險**: 安全模組獨立，不影響核心邏輯
- **中風險**: DOM操作變更可能影響樣式
- **緩解**: 充分測試，分階段部署

### 效能風險  
- **低風險**: 安全驗證開銷最小
- **緩解**: 效能監控，優化關鍵路徑

## 📝 驗收標準

### 功能驗收
- [ ] 所有現有功能正常運作
- [ ] NFC卡片讀取成功率100%
- [ ] 雙語切換無異常

### 安全驗收
- [ ] XSS測試集通過率100%
- [ ] URL驗證覆蓋率100%
- [ ] CSP違規零容忍

### 效能驗收
- [ ] 頁面載入時間增加<10%
- [ ] 記憶體使用增加<5%
- [ ] 安全驗證耗時<1ms

---
**架構師**: Amazon Q Developer CLI  
**審核**: 待定  
**最後更新**: 2025-09-08
