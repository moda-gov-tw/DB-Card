# 弱點修補任務清單

**文檔版本：** v1.0  
**建立日期：** 2025年9月8日  
**總弱點數：** 66 項 (31 High + 35 Medium)  
**修補狀態：** 🔴 進行中  

## 📋 任務總覽

### 優先級分布
- **Critical：** 8 項 (security-utils.js 核心問題)
- **High：** 23 項 (XSS + URL 清理問題)
- **Medium：** 35 項 (URL Redirect + DOM 問題)

### 預估工時
- **總計：** 12-16 小時
- **Critical 任務：** 4-6 小時
- **High 任務：** 6-8 小時
- **Medium 任務：** 2-2 小時

## 🚨 Critical 任務 (立即處理)

### Task C1: 升級 DOMPurify
**優先級：** Critical  
**預估時間：** 4-6 小時  
**負責人：** [待指派]  
**狀態：** ⏳ 待開始  

**描述：** 替換 security-utils.js 的 HTML 清理機制

**子任務：**
- [ ] C1.1 引入 DOMPurify 函式庫 (1h)
- [ ] C1.2 修改 sanitizeHTML 函數 (2h)
- [ ] C1.3 更新所有 HTML 檔案引用 (1h)
- [ ] C1.4 執行安全測試驗證 (1-2h)

**驗收標準：**
- [ ] 所有 XSS 測試通過
- [ ] security-utils.js 弱點清零
- [ ] 功能無回歸問題

**相關文檔：** [DOMPurify 升級指南](./DOMPURIFY-UPGRADE-GUIDE.md)

---

## 🔥 High 任務 (24小時內)

### Task H1: 修復 Client-side XSS (19項)
**優先級：** High  
**預估時間：** 3-4 小時  
**狀態：** ⏳ 待開始  

**影響檔案：**
- `index.html` (4項): 行 615, 629, 663, 667
- `index1.html` (5項): 行 616, 630, 664, 668, 725
- `index-en.html` (4項): 行 655, 667, 694, 698
- `index1-en.html` (4項): 行 655, 667, 694, 698
- `index1-bilingual.html` (1項): 行 562
- `assets/bilingual-common.js` (1項): 行 480

**修補方案：**
```diff
- element.innerHTML = userInput;
+ element.innerHTML = SecurityUtils.sanitizeHTML(userInput);
```

**驗收標準：**
- [ ] 所有 innerHTML 使用安全函數
- [ ] XSS Payload 測試通過
- [ ] 功能正常運作

### Task H2: 修復 URL Substring Sanitization (4項)
**優先級：** High  
**預估時間：** 2-3 小時  
**狀態：** ⏳ 待開始  

**影響檔案：**
- `index.html`: 行 611
- `index1.html`: 行 612
- `index-en.html`: 行 651
- `index1-en.html`: 行 651

**修補方案：**
- 修復 URL 驗證邏輯錯誤
- 確保先驗證後編碼的正確流程

### Task H3: 實施 Content Security Policy
**優先級：** High  
**預估時間：** 1-2 小時  
**狀態：** ⏳ 待開始  

**實施方案：**
```html
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com;">
```

---

## ⚠️ Medium 任務 (一週內)

### Task M1: 修復 Client-side URL Redirect (32項)
**優先級：** Medium  
**預估時間：** 1-2 小時  
**狀態：** ⏳ 待開始  

**主要影響：** 社群連結處理邏輯

**修補方案：**
- 在 validateURL 中加入 Origin 白名單
- 修復 bilingual-common.js 重定向邏輯

### Task M2: 修復 DOM Text Reinterpreted (3項)
**優先級：** Medium  
**預估時間：** 30分鐘  
**狀態：** ⏳ 待開始  

**影響檔案：**
- `tests/test-social-links.html`: 行 165
- `tests/test-accessibility.html`: 行 60
- `nfc-generator-bilingual.html`: 行 507

---

## 📊 進度追蹤

### 完成狀態
- **Critical：** 0/8 (0%)
- **High：** 0/23 (0%)
- **Medium：** 0/35 (0%)
- **總計：** 0/66 (0%)

### 里程碑
- [ ] **里程碑 1：** Critical 任務完成 (目標：24小時內)
- [ ] **里程碑 2：** High 任務完成 (目標：48小時內)
- [ ] **里程碑 3：** Medium 任務完成 (目標：一週內)
- [ ] **里程碑 4：** CodeQL 重新掃描通過

## 🧪 測試計畫

### 安全測試
- [ ] 執行 `tests/test-security-comprehensive.html`
- [ ] 執行 `tests/test-security-final.html`
- [ ] 手動 XSS Payload 測試
- [ ] Open Redirect 測試

### 功能測試
- [ ] NFC 名片生成功能
- [ ] 雙語切換功能
- [ ] QR 碼生成功能
- [ ] vCard 下載功能

### 效能測試
- [ ] 頁面載入時間
- [ ] HTML 清理效能
- [ ] 記憶體使用情況

## 📋 驗收檢查清單

### 安全驗收
- [ ] CodeQL 掃描弱點數量 < 5
- [ ] 所有 Critical/High 弱點修復
- [ ] 安全測試套件 100% 通過
- [ ] CSP 策略正確實施

### 功能驗收
- [ ] 所有核心功能正常
- [ ] 無功能回歸問題
- [ ] 使用者體驗無影響
- [ ] 跨瀏覽器相容性良好

### 文檔驗收
- [ ] 修補記錄完整
- [ ] 技術文檔更新
- [ ] 測試報告完成
- [ ] 部署指南更新

## 🔄 風險管理

### 高風險項目
1. **DOMPurify 整合失敗** - 準備回退方案
2. **功能回歸問題** - 完整測試覆蓋
3. **效能影響** - 效能監控與優化

### 緩解措施
- 分階段實施，逐步驗證
- 保持 Git 版本控制
- 準備快速回退方案
- 建立完整測試覆蓋

## 📚 相關資源

- [安全掃描分析報告](./SECURITY-ANALYSIS-20250908.md)
- [DOMPurify 升級指南](./DOMPURIFY-UPGRADE-GUIDE.md)
- [測試執行指南](../tests/README.md)
- [Gemini 審查報告](../.amazonq/reports/)

---
**維護說明：** 每完成一個任務應更新此清單，記錄實際耗時與遇到的問題。
