<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medium 風險修補測試</title>
    <script src="../assets/security-utils.js"></script>
    <script src="../assets/dompurify.min.js"></script>
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .fail { background-color: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>Medium 風險修補測試</h1>
    
    <div id="test-results"></div>
    
    <script>
        function runMediumRiskTests() {
            const results = [];
            
            // 測試 1: Open Redirect 防護
            function testOpenRedirectProtection() {
                const maliciousUrls = [
                    'https://evil.com/phishing',
                    'http://attacker.site/steal-data',
                    '//evil.com/redirect'
                ];
                
                const allowedOrigins = ['https://trusted-partner.com'];
                
                maliciousUrls.forEach(url => {
                    const isBlocked = !SecurityUtils.validateURL(url, allowedOrigins);
                    results.push({
                        test: `Open Redirect 防護 - ${url}`,
                        pass: isBlocked,
                        details: isBlocked ? '成功阻擋惡意重定向' : '⚠️ 未能阻擋惡意重定向'
                    });
                });
                
                // 測試合法 URL 仍可通過
                const legitimateUrls = [
                    window.location.origin + '/page',
                    'https://trusted-partner.com/api',
                    'mailto:test@example.com',
                    'tel:+1234567890'
                ];
                
                legitimateUrls.forEach(url => {
                    const isAllowed = SecurityUtils.validateURL(url, allowedOrigins);
                    results.push({
                        test: `合法 URL 通過 - ${url}`,
                        pass: isAllowed,
                        details: isAllowed ? '合法 URL 正確通過' : '⚠️ 合法 URL 被誤擋'
                    });
                });
            }
            
            // 測試 2: DOM 安全處理
            function testDOMSafety() {
                const testDiv = document.createElement('div');
                const maliciousContent = '<img src=x onerror=alert("XSS")>Malicious content';
                
                // 測試 safeRender 是否正確清理
                SecurityUtils.safeRender(testDiv, maliciousContent, true);
                const cleanedContent = testDiv.innerHTML;
                
                const isSafe = !cleanedContent.includes('onerror') && 
                              !cleanedContent.includes('alert');
                
                results.push({
                    test: 'DOM 安全渲染',
                    pass: isSafe,
                    details: isSafe ? 
                        '惡意腳本已被清理' : 
                        `⚠️ 清理失敗: ${cleanedContent}`
                });
            }
            
            // 測試 3: 社群連結安全處理
            function testSocialLinksSafety() {
                // 模擬社群連結處理（如果 processSocialLinks 可用）
                if (typeof processSocialLinks !== 'undefined') {
                    const maliciousInput = 'GitHub: <script>alert("XSS")</script>evil-user';
                    try {
                        const processed = processSocialLinks(maliciousInput);
                        const isSafe = !processed.includes('<script>') && 
                                      !processed.includes('alert');
                        
                        results.push({
                            test: '社群連結安全處理',
                            pass: isSafe,
                            details: isSafe ? 
                                '社群連結已安全處理' : 
                                `⚠️ 處理不安全: ${processed}`
                        });
                    } catch (error) {
                        results.push({
                            test: '社群連結安全處理',
                            pass: false,
                            details: `處理錯誤: ${error.message}`
                        });
                    }
                } else {
                    results.push({
                        test: '社群連結安全處理',
                        pass: true,
                        details: 'processSocialLinks 函數未載入，跳過測試'
                    });
                }
            }
            
            // 執行所有測試
            testOpenRedirectProtection();
            testDOMSafety();
            testSocialLinksSafety();
            
            // 顯示結果
            const resultsDiv = document.getElementById('test-results');
            const passCount = results.filter(r => r.pass).length;
            
            const resultHTML = `
                <h2>Medium 風險修補測試結果: ${passCount}/${results.length} 通過</h2>
                ${results.map(result => `
                    <div class="test-result ${result.pass ? 'pass' : 'fail'}">
                        <h3>${result.test}: ${result.pass ? '✅ PASS' : '❌ FAIL'}</h3>
                        <p>${result.details}</p>
                    </div>
                `).join('')}
                
                <h3>測試摘要:</h3>
                <ul>
                    <li>Open Redirect 防護: 檢查是否阻擋跨域重定向</li>
                    <li>DOM 安全處理: 驗證 innerHTML 替換為安全渲染</li>
                    <li>社群連結安全: 確保社群連結處理無 XSS 風險</li>
                </ul>
            `;
            
            SecurityUtils.safeRender(resultsDiv, resultHTML, true);
        }
        
        // 頁面載入後執行測試
        document.addEventListener('DOMContentLoaded', runMediumRiskTests);
    </script>
</body>
</html>
