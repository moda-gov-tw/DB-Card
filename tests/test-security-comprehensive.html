<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src 'self' fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self';">
    <title>å…¨é¢å®‰å…¨æ¸¬è©¦</title>
    <script src="../assets/security-utils.js"></script>
    <script src="../assets/bilingual-common.js"></script>
</head>
<body>
    <h1>å…¨é¢å®‰å…¨æ¸¬è©¦ - Task 5.2</h1>
    <div id="test-results"></div>

    <script>
        function runComprehensiveSecurityTests() {
            const results = [];
            
            // æ¸¬è©¦1: XSS Payloadæ¸¬è©¦
            const xssPayloads = [
                '<script>alert("xss1")</script>',
                '<img src=x onerror=alert(1)>',
                'javascript:alert("xss3")',
                '<svg onload=alert(1)>',
                '"><script>alert("xss5")</script>'
            ];
            
            xssPayloads.forEach((payload, index) => {
                const sanitized = SecurityUtils.sanitizeInput(payload);
                results.push({
                    test: `XSS Payload ${index + 1}`,
                    input: payload,
                    output: sanitized,
                    pass: !sanitized.includes('<script>') && !sanitized.includes('onerror') && !sanitized.includes('onload')
                });
            });
            
            // æ¸¬è©¦2: URLé©—è­‰æ¸¬è©¦
            const maliciousUrls = [
                'javascript:alert("hack")',
                'data:text/html,<script>alert("hack")</script>',
                'vbscript:msgbox("hack")',
                '//evil-site.com/malware',
                'ftp://malicious.com'
            ];
            
            maliciousUrls.forEach((url, index) => {
                const isValid = SecurityUtils.validateURL(url);
                results.push({
                    test: `æƒ¡æ„URL ${index + 1}`,
                    input: url,
                    pass: !isValid,
                    details: `URLè¢«${isValid ? 'å…è¨±' : 'é˜»æ“‹'}`
                });
            });
            
            // æ¸¬è©¦3: åˆæ³•URLæ¸¬è©¦
            const legitimateUrls = [
                'https://example.com',
                'http://localhost:3000',
                'mailto:test@example.com',
                'tel:+886912345678'
            ];
            
            legitimateUrls.forEach((url, index) => {
                const isValid = SecurityUtils.validateURL(url);
                results.push({
                    test: `åˆæ³•URL ${index + 1}`,
                    input: url,
                    pass: isValid,
                    details: `URLè¢«${isValid ? 'å…è¨±' : 'é˜»æ“‹'}`
                });
            });
            
            // æ¸¬è©¦4: å®‰å…¨æ¸²æŸ“æ¸¬è©¦
            const testDiv = document.createElement('div');
            const htmlContent = '<p>æ­£å¸¸å…§å®¹</p><script>alert("evil")</script><img src=x onerror=alert("evil2")>';
            SecurityUtils.safeRender(testDiv, htmlContent, true);
            
            results.push({
                test: 'å®‰å…¨HTMLæ¸²æŸ“',
                input: htmlContent,
                output: testDiv.innerHTML,
                pass: !testDiv.innerHTML.includes('<script>') && !testDiv.innerHTML.includes('onerror')
            });
            
            // æ¸¬è©¦5: ç¤¾ç¾¤é€£çµå®‰å…¨æ¸¬è©¦
            const container = document.createElement('div');
            const maliciousLink = createSocialElement('Test', 'javascript:alert("social-hack")', 'Test', '#007cba');
            container.appendChild(maliciousLink);
            
            const linkElement = maliciousLink.querySelector('a');
            results.push({
                test: 'ç¤¾ç¾¤é€£çµå®‰å…¨è™•ç†',
                pass: linkElement.getAttribute('aria-disabled') === 'true' && !linkElement.hasAttribute('href'),
                details: `é€£çµè¢«æ­£ç¢ºç¦ç”¨: aria-disabled=${linkElement.getAttribute('aria-disabled')}`
            });
            
            // æ¸¬è©¦7: DOM Clobbering é˜²è­·
            results.push(testDOMClobbering());
            
            // é¡¯ç¤ºçµæœ
            const resultsDiv = document.getElementById('test-results');
            const passCount = results.filter(r => r.pass).length;
            const totalTests = results.length;
            
            resultsDiv.innerHTML = `
                <h2>å®‰å…¨æ¸¬è©¦çµæœ: ${passCount}/${totalTests} é€šé (${Math.round(passCount/totalTests*100)}%)</h2>
                <div style="margin: 20px 0;">
                    <strong>æ¸¬è©¦æ‘˜è¦:</strong><br>
                    XSSé˜²è­·: ${results.slice(0,5).filter(r => r.pass).length}/5<br>
                    æƒ¡æ„URLé˜»æ“‹: ${results.slice(5,10).filter(r => r.pass).length}/5<br>
                    åˆæ³•URLå…è¨±: ${results.slice(10,14).filter(r => r.pass).length}/4<br>
                    å®‰å…¨æ¸²æŸ“: ${results.slice(14,15).filter(r => r.pass).length}/1<br>
                    ç¤¾ç¾¤é€£çµå®‰å…¨: ${results.slice(15,16).filter(r => r.pass).length}/1<br>
                    DOM Clobberingé˜²è­·: ${results.slice(16,17).filter(r => r.pass).length}/1
                </div>
                ${results.map(result => `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid ${result.pass ? 'green' : 'red'}; border-radius: 4px;">
                        <h3>${result.test}: ${result.pass ? 'âœ… PASS' : 'âŒ FAIL'}</h3>
                        <p><strong>è¼¸å…¥:</strong> ${result.input || 'N/A'}</p>
                        ${result.output ? `<p><strong>è¼¸å‡º:</strong> ${result.output}</p>` : ''}
                        ${result.details ? `<p><strong>è©³æƒ…:</strong> ${result.details}</p>` : ''}
                    </div>
                `).join('')}
                
                <div style="margin-top: 20px; padding: 15px; background: ${passCount === totalTests ? '#d4edda' : '#f8d7da'}; border-radius: 4px;">
                    <h3>${passCount === totalTests ? 'ğŸ‰ æ‰€æœ‰å®‰å…¨æ¸¬è©¦é€šéï¼' : 'âš ï¸ ç™¼ç¾å®‰å…¨å•é¡Œï¼Œéœ€è¦æª¢æŸ¥'}</h3>
                    <p>Task 5.2 å…¨é¢å®‰å…¨æ¸¬è©¦ ${passCount === totalTests ? 'å®Œæˆ' : 'éƒ¨åˆ†å®Œæˆ'}</p>
                </div>
            `;
        }
        
        // DOM Clobbering é˜²è­·æ¸¬è©¦
        function testDOMClobbering() {
            const clobberDiv = document.createElement('div');
            // æ­¤ payload å˜—è©¦å‰µå»ºä¸€å€‹ name ç‚º 'SecurityUtils' çš„ form å…ƒç´ 
            const clobberPayload = '<form id="SecurityUtils"></form>';
            SecurityUtils.safeRender(clobberDiv, clobberPayload, true);
            document.body.appendChild(clobberDiv); // éœ€å°‡å…ƒç´ é™„åŠ åˆ°DOMæ‰èƒ½è§¸ç™¼

            const isClobbered = typeof window.SecurityUtils !== 'object';
            
            const result = {
                test: 'DOM Clobbering é˜²è­·',
                input: clobberPayload,
                pass: !isClobbered,
                details: `æ¸¬è©¦å¾Œ window.SecurityUtils é¡å‹ç‚º: ${typeof window.SecurityUtils} (é æœŸ: object)`
            };
            
            document.body.removeChild(clobberDiv); // æ¸…ç†
            return result;
        }
        
        // åŸ·è¡Œæ¸¬è©¦
        runComprehensiveSecurityTests();
    </script>
</body>
</html>
