<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最終安全驗證測試</title>
    <script src="../assets/security-utils.js"></script>
    <script src="../assets/bilingual-common.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        #test-container { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>🔒 最終安全驗證測試</h1>
    
    <div class="test-section">
        <h2>1. XSS 防護測試</h2>
        <div id="xss-test-result"></div>
        <div id="xss-test-container"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Open Redirect 防護測試</h2>
        <div id="redirect-test-result"></div>
        <div id="redirect-test-container"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Accessibility 測試</h2>
        <div id="accessibility-test-result"></div>
        <div id="accessibility-test-container"></div>
    </div>

    <script>
        // 測試結果記錄
        let testResults = {
            xss: false,
            redirect: false,
            accessibility: false
        };

        // 1. XSS 防護測試
        function testXSSProtection() {
            console.log('=== XSS 防護測試開始 ===');
            
            // 測試惡意腳本注入
            const maliciousData = {
                social: {
                    linkedin: 'https://linkedin.com/in/test'
                },
                name: 'Test User'
            };
            
            // 添加惡意內容
            maliciousData.social.linkedin += '<img src=x onerror=alert(1)>';
            maliciousData.name += '<script>alert(1)</script>';
            
            try {
                // 測試 safeRender 函數
                const testElement = document.createElement('div');
                SecurityUtils.safeRender(testElement, maliciousData.name);
                
                // 檢查是否包含腳本標籤
                const hasScript = testElement.innerHTML.includes('<script>');
                const hasOnError = testElement.innerHTML.includes('onerror=');
                
                if (!hasScript && !hasOnError) {
                    document.getElementById('xss-test-result').innerHTML = '<span class="pass">✅ XSS 防護測試通過</span>';
                    testResults.xss = true;
                } else {
                    document.getElementById('xss-test-result').innerHTML = '<span class="fail">❌ XSS 防護測試失敗</span>';
                }
                
                document.getElementById('xss-test-container').appendChild(testElement);
                
            } catch (error) {
                document.getElementById('xss-test-result').innerHTML = '<span class="fail">❌ XSS 測試執行錯誤: ' + error.message + '</span>';
            }
        }

        // 2. Open Redirect 防護測試
        function testOpenRedirectProtection() {
            console.log('=== Open Redirect 防護測試開始 ===');
            
            const maliciousUrls = [
                'javascript:alert(1)',
                '//evil-website.com',
                'http://malicious.com',
                'data:text/html,<script>alert(1)</script>'
            ];
            
            let passCount = 0;
            const container = document.getElementById('redirect-test-container');
            
            maliciousUrls.forEach((url, index) => {
                try {
                    const linkElement = createSocialElement('test', url, 'Test', '#007cba');
                    container.appendChild(linkElement);
                    
                    // 檢查連結是否被正確禁用
                    const link = linkElement.querySelector('a');
                    if (link && link.getAttribute('aria-disabled') === 'true' && !link.hasAttribute('href')) {
                        passCount++;
                        console.log('✅ 惡意 URL ' + (index + 1) + ' 被正確阻擋:', url);
                    } else {
                        console.log('❌ 惡意 URL ' + (index + 1) + ' 未被阻擋:', url);
                    }
                } catch (error) {
                    console.error('測試 URL 時發生錯誤:', url, error);
                }
            });
            
            if (passCount === maliciousUrls.length) {
                document.getElementById('redirect-test-result').innerHTML = '<span class="pass">✅ Open Redirect 防護測試通過</span>';
                testResults.redirect = true;
            } else {
                document.getElementById('redirect-test-result').innerHTML = '<span class="fail">❌ Open Redirect 防護測試失敗 (' + passCount + '/' + maliciousUrls.length + ')</span>';
            }
        }

        // 3. Accessibility 測試
        function testAccessibility() {
            console.log('=== Accessibility 測試開始 ===');
            
            const container = document.getElementById('accessibility-test-container');
            const testLink = createSocialElement('test', 'javascript:void(0)', 'Test', '#007cba');
            container.appendChild(testLink);
            
            const link = testLink.querySelector('a');
            const hasAriaDisabled = link.getAttribute('aria-disabled') === 'true';
            const hasRole = link.getAttribute('role') === 'link';
            const hasNoHref = !link.hasAttribute('href');
            const hasPointerEvents = link.style.pointerEvents === 'none';
            const hasOpacity = parseFloat(link.style.opacity) === 0.5;
            
            const accessibilityChecks = [
                { name: 'aria-disabled="true"', passed: hasAriaDisabled },
                { name: 'role="link"', passed: hasRole },
                { name: '無 href 屬性', passed: hasNoHref },
                { name: 'pointerEvents: none', passed: hasPointerEvents },
                { name: 'opacity: 0.5', passed: hasOpacity }
            ];
            
            const passedChecks = accessibilityChecks.filter(check => check.passed).length;
            
            if (passedChecks === accessibilityChecks.length) {
                document.getElementById('accessibility-test-result').innerHTML = '<span class="pass">✅ Accessibility 測試通過</span>';
                testResults.accessibility = true;
            } else {
                document.getElementById('accessibility-test-result').innerHTML = '<span class="fail">❌ Accessibility 測試失敗 (' + passedChecks + '/' + accessibilityChecks.length + ')</span>';
            }
            
            // 顯示詳細結果
            const detailsDiv = document.createElement('div');
            detailsDiv.innerHTML = '<h4>詳細檢查結果:</h4>';
            accessibilityChecks.forEach(check => {
                const status = check.passed ? '✅' : '❌';
                detailsDiv.innerHTML += '<div>' + status + ' ' + check.name + '</div>';
            });
            container.appendChild(detailsDiv);
        }

        // 執行所有測試
        function runAllTests() {
            setTimeout(() => {
                testXSSProtection();
                testOpenRedirectProtection();
                testAccessibility();
                
                // 顯示總結
                setTimeout(() => {
                    const totalPassed = Object.values(testResults).filter(result => result).length;
                    const totalTests = Object.keys(testResults).length;
                    
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'test-section';
                    summaryDiv.innerHTML = 
                        '<h2>📊 測試總結</h2>' +
                        '<div class="' + (totalPassed === totalTests ? 'pass' : 'fail') + '">' +
                            '通過測試: ' + totalPassed + '/' + totalTests +
                        '</div>' +
                        (totalPassed === totalTests ? 
                            '<div class="pass">🎉 所有安全測試通過！系統已準備就緒。</div>' : 
                            '<div class="fail">⚠️ 部分測試失敗，請檢查相關功能。</div>'
                        );
                    document.body.appendChild(summaryDiv);
                }, 1000);
            }, 500);
        }

        // 頁面載入完成後執行測試
        window.addEventListener('load', runAllTests);
    </script>
</body>
</html>
