<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€çµ‚å®‰å…¨é©—è­‰æ¸¬è©¦</title>
    <script src="../assets/security-utils.js"></script>
    <script src="../assets/bilingual-common.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        #test-container { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ”’ æœ€çµ‚å®‰å…¨é©—è­‰æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>1. XSS é˜²è­·æ¸¬è©¦</h2>
        <div id="xss-test-result"></div>
        <div id="xss-test-container"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Open Redirect é˜²è­·æ¸¬è©¦</h2>
        <div id="redirect-test-result"></div>
        <div id="redirect-test-container"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Accessibility æ¸¬è©¦</h2>
        <div id="accessibility-test-result"></div>
        <div id="accessibility-test-container"></div>
    </div>

    <script>
        // æ¸¬è©¦çµæœè¨˜éŒ„
        let testResults = {
            xss: false,
            redirect: false,
            accessibility: false
        };

        // 1. XSS é˜²è­·æ¸¬è©¦
        function testXSSProtection() {
            console.log('=== XSS é˜²è­·æ¸¬è©¦é–‹å§‹ ===');
            
            // æ¸¬è©¦æƒ¡æ„è…³æœ¬æ³¨å…¥
            const maliciousData = {
                social: {
                    linkedin: 'https://linkedin.com/in/test'
                },
                name: 'Test User'
            };
            
            // æ·»åŠ æƒ¡æ„å…§å®¹
            maliciousData.social.linkedin += '<img src=x onerror=alert(1)>';
            maliciousData.name += '<script>alert(1)</script>';
            
            try {
                // æ¸¬è©¦ safeRender å‡½æ•¸
                const testElement = document.createElement('div');
                SecurityUtils.safeRender(testElement, maliciousData.name);
                
                // æª¢æŸ¥æ˜¯å¦åŒ…å«è…³æœ¬æ¨™ç±¤
                const hasScript = testElement.innerHTML.includes('<script>');
                const hasOnError = testElement.innerHTML.includes('onerror=');
                
                if (!hasScript && !hasOnError) {
                    document.getElementById('xss-test-result').innerHTML = '<span class="pass">âœ… XSS é˜²è­·æ¸¬è©¦é€šé</span>';
                    testResults.xss = true;
                } else {
                    document.getElementById('xss-test-result').innerHTML = '<span class="fail">âŒ XSS é˜²è­·æ¸¬è©¦å¤±æ•—</span>';
                }
                
                document.getElementById('xss-test-container').appendChild(testElement);
                
            } catch (error) {
                document.getElementById('xss-test-result').innerHTML = '<span class="fail">âŒ XSS æ¸¬è©¦åŸ·è¡ŒéŒ¯èª¤: ' + error.message + '</span>';
            }
        }

        // 2. Open Redirect é˜²è­·æ¸¬è©¦
        function testOpenRedirectProtection() {
            console.log('=== Open Redirect é˜²è­·æ¸¬è©¦é–‹å§‹ ===');
            
            const maliciousUrls = [
                'javascript:alert(1)',
                '//evil-website.com',
                'http://malicious.com',
                'data:text/html,<script>alert(1)</script>'
            ];
            
            let passCount = 0;
            const container = document.getElementById('redirect-test-container');
            
            maliciousUrls.forEach((url, index) => {
                try {
                    const linkElement = createSocialElement('test', url, 'Test', '#007cba');
                    container.appendChild(linkElement);
                    
                    // æª¢æŸ¥é€£çµæ˜¯å¦è¢«æ­£ç¢ºç¦ç”¨
                    const link = linkElement.querySelector('a');
                    if (link && link.getAttribute('aria-disabled') === 'true' && !link.hasAttribute('href')) {
                        passCount++;
                        console.log('âœ… æƒ¡æ„ URL ' + (index + 1) + ' è¢«æ­£ç¢ºé˜»æ“‹:', url);
                    } else {
                        console.log('âŒ æƒ¡æ„ URL ' + (index + 1) + ' æœªè¢«é˜»æ“‹:', url);
                    }
                } catch (error) {
                    console.error('æ¸¬è©¦ URL æ™‚ç™¼ç”ŸéŒ¯èª¤:', url, error);
                }
            });
            
            if (passCount === maliciousUrls.length) {
                document.getElementById('redirect-test-result').innerHTML = '<span class="pass">âœ… Open Redirect é˜²è­·æ¸¬è©¦é€šé</span>';
                testResults.redirect = true;
            } else {
                document.getElementById('redirect-test-result').innerHTML = '<span class="fail">âŒ Open Redirect é˜²è­·æ¸¬è©¦å¤±æ•— (' + passCount + '/' + maliciousUrls.length + ')</span>';
            }
        }

        // 3. Accessibility æ¸¬è©¦
        function testAccessibility() {
            console.log('=== Accessibility æ¸¬è©¦é–‹å§‹ ===');
            
            const container = document.getElementById('accessibility-test-container');
            const testLink = createSocialElement('test', 'javascript:void(0)', 'Test', '#007cba');
            container.appendChild(testLink);
            
            const link = testLink.querySelector('a');
            const hasAriaDisabled = link.getAttribute('aria-disabled') === 'true';
            const hasRole = link.getAttribute('role') === 'link';
            const hasNoHref = !link.hasAttribute('href');
            const hasPointerEvents = link.style.pointerEvents === 'none';
            const hasOpacity = parseFloat(link.style.opacity) === 0.5;
            
            const accessibilityChecks = [
                { name: 'aria-disabled="true"', passed: hasAriaDisabled },
                { name: 'role="link"', passed: hasRole },
                { name: 'ç„¡ href å±¬æ€§', passed: hasNoHref },
                { name: 'pointerEvents: none', passed: hasPointerEvents },
                { name: 'opacity: 0.5', passed: hasOpacity }
            ];
            
            const passedChecks = accessibilityChecks.filter(check => check.passed).length;
            
            if (passedChecks === accessibilityChecks.length) {
                document.getElementById('accessibility-test-result').innerHTML = '<span class="pass">âœ… Accessibility æ¸¬è©¦é€šé</span>';
                testResults.accessibility = true;
            } else {
                document.getElementById('accessibility-test-result').innerHTML = '<span class="fail">âŒ Accessibility æ¸¬è©¦å¤±æ•— (' + passedChecks + '/' + accessibilityChecks.length + ')</span>';
            }
            
            // é¡¯ç¤ºè©³ç´°çµæœ
            const detailsDiv = document.createElement('div');
            detailsDiv.innerHTML = '<h4>è©³ç´°æª¢æŸ¥çµæœ:</h4>';
            accessibilityChecks.forEach(check => {
                const status = check.passed ? 'âœ…' : 'âŒ';
                detailsDiv.innerHTML += '<div>' + status + ' ' + check.name + '</div>';
            });
            container.appendChild(detailsDiv);
        }

        // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
        function runAllTests() {
            setTimeout(() => {
                testXSSProtection();
                testOpenRedirectProtection();
                testAccessibility();
                
                // é¡¯ç¤ºç¸½çµ
                setTimeout(() => {
                    const totalPassed = Object.values(testResults).filter(result => result).length;
                    const totalTests = Object.keys(testResults).length;
                    
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'test-section';
                    summaryDiv.innerHTML = 
                        '<h2>ğŸ“Š æ¸¬è©¦ç¸½çµ</h2>' +
                        '<div class="' + (totalPassed === totalTests ? 'pass' : 'fail') + '">' +
                            'é€šéæ¸¬è©¦: ' + totalPassed + '/' + totalTests +
                        '</div>' +
                        (totalPassed === totalTests ? 
                            '<div class="pass">ğŸ‰ æ‰€æœ‰å®‰å…¨æ¸¬è©¦é€šéï¼ç³»çµ±å·²æº–å‚™å°±ç·’ã€‚</div>' : 
                            '<div class="fail">âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç›¸é—œåŠŸèƒ½ã€‚</div>'
                        );
                    document.body.appendChild(summaryDiv);
                }, 1000);
            }, 500);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œæ¸¬è©¦
        window.addEventListener('load', runAllTests);
    </script>
</body>
</html>
