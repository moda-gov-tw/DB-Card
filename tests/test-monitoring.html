<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨ç›£æ§æ©Ÿåˆ¶æ¸¬è©¦</title>
    <script src="../assets/security-utils.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .log-entry { 
            background: #f5f5f5; 
            padding: 8px; 
            margin: 4px 0; 
            border-left: 3px solid #007cba; 
            font-family: monospace; 
            font-size: 0.9em;
        }
        button { 
            background: #007cba; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            margin: 4px; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #005a87; }
    </style>
</head>
<body>
    <h1>ğŸ” å®‰å…¨ç›£æ§æ©Ÿåˆ¶æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>1. éŒ¯èª¤è™•ç†æ¸¬è©¦</h2>
        <button onclick="testErrorHandling()">è§¸ç™¼éŒ¯èª¤è™•ç†æ¸¬è©¦</button>
        <div id="error-test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. å®‰å…¨æ—¥èªŒè¨˜éŒ„</h2>
        <button onclick="testSecurityLogging()">è§¸ç™¼å®‰å…¨äº‹ä»¶</button>
        <button onclick="displayLogs()">é¡¯ç¤ºå®‰å…¨æ—¥èªŒ</button>
        <button onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
        <div id="logs-display"></div>
    </div>
    
    <div class="test-section">
        <h2>3. ç›£æ§åŠŸèƒ½é©—è­‰</h2>
        <button onclick="runMonitoringTests()">åŸ·è¡Œç›£æ§æ¸¬è©¦</button>
        <div id="monitoring-result"></div>
    </div>

    <script>
        // éŒ¯èª¤è™•ç†æ¸¬è©¦
        function testErrorHandling() {
            console.log('=== éŒ¯èª¤è™•ç†æ¸¬è©¦é–‹å§‹ ===');
            
            const results = [];
            
            // æ¸¬è©¦ 1: safeRender éŒ¯èª¤è™•ç†
            try {
                SecurityUtils.safeRender(null, 'test content');
                results.push('âœ… safeRender null element è™•ç†æ­£å¸¸');
            } catch (e) {
                results.push('âŒ safeRender null element è™•ç†å¤±æ•—: ' + e.message);
            }
            
            // æ¸¬è©¦ 2: validateURL éŒ¯èª¤è™•ç†
            try {
                const result1 = SecurityUtils.validateURL(null);
                const result2 = SecurityUtils.validateURL('invalid-url');
                const result3 = SecurityUtils.validateURL('javascript:alert("test")');
                
                if (!result1 && !result2 && !result3) {
                    results.push('âœ… validateURL éŒ¯èª¤è™•ç†æ­£å¸¸');
                } else {
                    results.push('âŒ validateURL éŒ¯èª¤è™•ç†ç•°å¸¸');
                }
            } catch (e) {
                results.push('âŒ validateURL éŒ¯èª¤è™•ç†å¤±æ•—: ' + e.message);
            }
            
            // æ¸¬è©¦ 3: getSecureURLParam éŒ¯èª¤è™•ç†
            try {
                const result = SecurityUtils.getSecureURLParam('nonexistent');
                results.push('âœ… getSecureURLParam éŒ¯èª¤è™•ç†æ­£å¸¸');
            } catch (e) {
                results.push('âŒ getSecureURLParam éŒ¯èª¤è™•ç†å¤±æ•—: ' + e.message);
            }
            
            document.getElementById('error-test-result').innerHTML = results.join('<br>');
        }
        
        // å®‰å…¨æ—¥èªŒæ¸¬è©¦
        function testSecurityLogging() {
            console.log('=== å®‰å…¨æ—¥èªŒæ¸¬è©¦é–‹å§‹ ===');
            
            // è§¸ç™¼å„ç¨®å®‰å…¨äº‹ä»¶
            SecurityUtils.validateURL('javascript:alert("test")');
            SecurityUtils.validateURL('//malicious.com');
            SecurityUtils.safeRender(null, 'test');
            SecurityUtils.getSecureURLParam('test');
            
            alert('å®‰å…¨äº‹ä»¶å·²è§¸ç™¼ï¼Œè«‹é»æ“Š"é¡¯ç¤ºå®‰å…¨æ—¥èªŒ"æŸ¥çœ‹è¨˜éŒ„');
        }
        
        // é¡¯ç¤ºå®‰å…¨æ—¥èªŒ
        function displayLogs() {
            const logs = SecurityUtils.getSecurityLogs();
            const logsDisplay = document.getElementById('logs-display');
            
            if (logs.length === 0) {
                logsDisplay.innerHTML = '<p>ç›®å‰æ²’æœ‰å®‰å…¨æ—¥èªŒè¨˜éŒ„</p>';
                return;
            }
            
            let html = `<h4>å®‰å…¨æ—¥èªŒ (${logs.length} æ¢è¨˜éŒ„)</h4>`;
            logs.slice(-10).forEach(log => { // é¡¯ç¤ºæœ€è¿‘10æ¢
                html += `<div class="log-entry">
                    <strong>${log.timestamp}</strong> - ${log.function}<br>
                    äº‹ä»¶: ${log.event}<br>
                    è©³æƒ…: ${JSON.stringify(log.details)}
                </div>`;
            });
            
            logsDisplay.innerHTML = html;
        }
        
        // æ¸…é™¤æ—¥èªŒ
        function clearLogs() {
            SecurityUtils.clearSecurityLogs();
            document.getElementById('logs-display').innerHTML = '<p>æ—¥èªŒå·²æ¸…é™¤</p>';
        }
        
        // ç›£æ§åŠŸèƒ½é©—è­‰
        function runMonitoringTests() {
            console.log('=== ç›£æ§åŠŸèƒ½é©—è­‰é–‹å§‹ ===');
            
            const results = [];
            
            // æ¸¬è©¦æ—¥èªŒè¨˜éŒ„åŠŸèƒ½
            const initialLogCount = SecurityUtils.getSecurityLogs().length;
            SecurityUtils.logSecurityEvent('test', 'monitoring test', { testData: 'test' });
            const newLogCount = SecurityUtils.getSecurityLogs().length;
            
            if (newLogCount > initialLogCount) {
                results.push('âœ… æ—¥èªŒè¨˜éŒ„åŠŸèƒ½æ­£å¸¸');
            } else {
                results.push('âŒ æ—¥èªŒè¨˜éŒ„åŠŸèƒ½ç•°å¸¸');
            }
            
            // æ¸¬è©¦æ—¥èªŒæ¸…é™¤åŠŸèƒ½
            SecurityUtils.clearSecurityLogs();
            const clearedLogCount = SecurityUtils.getSecurityLogs().length;
            
            if (clearedLogCount === 0) {
                results.push('âœ… æ—¥èªŒæ¸…é™¤åŠŸèƒ½æ­£å¸¸');
            } else {
                results.push('âŒ æ—¥èªŒæ¸…é™¤åŠŸèƒ½ç•°å¸¸');
            }
            
            // æ¸¬è©¦ sessionStorage å¯ç”¨æ€§
            try {
                sessionStorage.setItem('test', 'test');
                sessionStorage.removeItem('test');
                results.push('âœ… sessionStorage å¯ç”¨');
            } catch (e) {
                results.push('âš ï¸ sessionStorage ä¸å¯ç”¨: ' + e.message);
            }
            
            document.getElementById('monitoring-result').innerHTML = results.join('<br>');
        }
        
        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç•¶å‰ç‹€æ…‹
        window.addEventListener('load', function() {
            const logCount = SecurityUtils.getSecurityLogs().length;
            if (logCount > 0) {
                document.getElementById('logs-display').innerHTML = 
                    `<p>ç™¼ç¾ ${logCount} æ¢ç¾æœ‰æ—¥èªŒè¨˜éŒ„ï¼Œé»æ“Š"é¡¯ç¤ºå®‰å…¨æ—¥èªŒ"æŸ¥çœ‹</p>`;
            }
        });
    </script>
</body>
</html>
