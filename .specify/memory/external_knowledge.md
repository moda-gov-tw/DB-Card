I will start by searching for usages of `window.location` and URL parsing logic to identify potential unvalidated redirections.
I will search for assignments to `window.location.href`, `window.location.assign`, and `window.location.replace` to find potential unvalidated redirection vulnerabilities.
I will simplify the search pattern to find assignments or calls to `location.href`, `location.assign`, or `location.replace`, which are common ways to perform redirections.
I will examine `assets/security-utils.js` and search for usages of `window.open` to see if user-controlled input is being used for redirections or opening new windows.
I will examine `assets/security-utils.js` to see if there are any existing URL validation functions that could be used to mitigate unvalidated redirection risks.
I've noticed that `SecurityUtils` includes `validateURL` and `createSafeURL`, but I haven't found any explicit redirections yet. I'll examine `assets/bilingual-common.js` around line 950 to see how it handles query parameters, as several files use `URLSearchParams` there.
`initializePage` doesn't redirect based on `data`, so I'll check `nfc-generator.html` for `window.open(generatedUrl, ...)` to see if that's the cause of the CodeQL alert.
In `nfc-generator.html`, `previewCard` uses `generatedUrl`, which is built from local files and user-controlled inputs. While it seems safe, CodeQL might be flagging it. I'll check `nfc-generator-bilingual.html` and search for `location =` to see if there are any other redirections I might have missed.
I've seen `location` used for geographical data, so now I'll check for `window.location =` to find any potential URL redirections.
I'll check for `top.location`, `parent.location`, `assign(`, or `replace(` to see if there are any other redirection methods being used.
I'll re-examine `assets/security-utils.js` for any clues on Open Redirect fixes. Since I haven't found the typical `window.location.href = target` pattern, I'll also check `index.html` for any click handlers or other scripts that might be performing redirections.
`processSocialLinks` manually builds HTML with `<a>` tags, which are then rendered via `SecurityUtils.safeRender`. While `DOMPurify` protects against XSS, it doesn't prevent Open Redirect because `ALLOWED_URI_REGEXP` allows any `http:` or `https:` URL. I need to find where `window.location` is actually modified to address the CodeQL "Open Redirect" alert, so I'll start by listing all files to ensure I haven't missed any.
I'll check the `assets` directory.
I've checked the core scripts but haven't found a definitive cause for the "Open Redirect" alert. I'll re-examine `index1.html` and `nfc-generator.html`, specifically looking for any `eval` or `Function` constructors that could be performing redirections.
`SecurityUtils.setSecureAttribute` might be flagged by CodeQL as an unvalidated redirection because it assigns user-controlled values to `href` attributes without strict origin validation in all cases. While `validateURL` checks protocols, it doesn't always restrict origins. I'll search for `<a>` tag `click` handlers to see if there are any other potential redirection sinks.
The `click` handlers I found are for vCard downloads. I'll now examine `index-personal-en.html` to see if there's anything else relevant.
`index-personal-en.html`'s `createSafeSocialAnchor` uses `SecurityUtils.createSafeURL`, which in turn calls `validateURL`. Since `allowedOrigins` is omitted, `validateURL` only checks protocols, allowing links to any `https` site. While this might not be a classic "Open Redirect" if it requires a user click, I'll re-examine `assets/bilingual-common.js` for any `window.location.href` assignments that could be the source of the CodeQL alert.
`assets/bilingual-common.js` uses `allowedSocialOrigins` in `createSocialElement`, which is good. However, `validateURL` in `assets/security-utils.js` skips origin checks if `allowedOrigins` is empty, potentially allowing redirections to any `https` site. CodeQL might flag `element.setAttribute('href', value)` as a sink for this. I need to improve `validateURL` and ensure whitelists are provided where necessary, while still allowing legitimate social links. I'll check `doc/SECURITY-ANALYSIS-20250908.md` for more context.
The security report confirms that the "Client-side URL Redirect" issues primarily stem from the social link processing logic. While `assets/bilingual-common.js` has a safer version of `processSocialLinks`, several other files like `index.html` still use unvalidated implementations. I'll identify all files with their own `processSocialLinks` and update them to use `SecurityUtils.validateURL` with a whitelist or a more restrictive regex.
I need to fix `processSocialLinks` across several files, as many use unvalidated implementations. I'll also improve `SecurityUtils.validateURL` to always check origins for `http/https` URLs. I've noted that `SecurityUtils.safeRender` uses a broad `ALLOWED_URI_REGEXP`, which contributes to the "Open Redirect" risk. I'll also re-scan for any missed `window.location` assignments.
I realized `run_shell_command` is missing from my toolset, so I'll use `search_file_content` instead to find the information I need.
I've identified that `nfc-generator.html` and `nfc-generator-bilingual.html` use `window.open`, and `processSocialLinks` in several files like `index.html` creates unvalidated `<a>` tags, which CodeQL likely flags. I'll refactor `processSocialLinks` to use `SecurityUtils.validateURL` with a whitelist. To facilitate this, I'll move `allowedSocialOrigins` to `SecurityUtils` for shared access and then update `assets/security-utils.js`.
I'll add `ALLOWED_SOCIAL_DOMAINS` to `SecurityUtils` and enhance `validateURL` for stricter checks, specifically addressing the "Incomplete URL scheme check" noted in the report. I'll also ensure callers can use the new domain list for better security.
I'm adding `ALLOWED_SOCIAL_DOMAINS` to the `SecurityUtils` object and then I'll update `validateURL`.
I'm updating `validateURL` to be stricter, specifically addressing the issue where it allowed any `https` URL if `allowedOrigins` was empty, which is likely a CodeQL concern.
I've secured `SecurityUtils.validateURL` with a whitelist, protecting against Open Redirects for social links in that list. Now, I need to update `processSocialLinks` in `index.html` and other files to utilize this improved validation.
I'll now apply similar security enhancements to `index1.html`, `index-en.html`, `index1-en.html`, `index-personal.html`, and `index-personal-en.html`. `index-personal-en.html` already has some protection, but I'll upgrade it to use the new `SecurityUtils.validateURL` with the default whitelist. I suspect `index1.html` shares the same vulnerability as `index.html`.
`index1.html` is vulnerable too. I'll manually replace the problematic code in all identified files, one by one, since I can't easily run shell scripts.
I'll proceed with the replacements in `index-en.html`, `index1-en.html`, `index-personal.html`, and `index-personal-en.html`. I'll first check if `index-en.html` and `index1-en.html` use English comments or variable names in their `processSocialLinks` functions.
It's similar, but with some English comments and messages. I'll keep them as they are.
I'll update `index1-en.html`, which should match `index-en.html`.
I'm moving on to `index-personal.html` and `index-personal-en.html`.
`index-personal.html` is safer now that I've updated `SecurityUtils.validateURL`, but I'll still refactor its `processSocialLinks` for consistency. I'll also check `index-bilingual-personal.html` and update `assets/bilingual-common.js` to use `SecurityUtils.ALLOWED_SOCIAL_DOMAINS` instead of its local definition.
I've updated the core files and will now check `nfc-generator-bilingual.html`'s `processSocialLinksPreview` function for similar issues.
`processSocialLinksPreview` is safe from Open Redirect as it doesn't use `<a>` tags. I'll now check `nfc-generator.html` and `index-bilingual-personal.html` for similar issues.
I've addressed the `processSocialLinks` issues, and now I'll focus on `nfc-generator.html` and `nfc-generator-bilingual.html`. I'll add a `SecurityUtils.validateURL` check to `previewCard` before calling `window.open` to ensure `generatedUrl` is safe, even though it's likely already fine due to its same-origin nature.
Next, `nfc-generator-bilingual.html`.
I'll check if `VULNERABILITY-PATCH-TASKS.md` or `弱點修補任務清單.md` require updates.
Task M1 was marked complete in September, but the issue persists in December, likely due to an incomplete fix or subsequent regressions. I've now strengthened `SecurityUtils.validateURL` to always check origins, added `ALLOWED_SOCIAL_DOMAINS`, and updated `processSocialLinks` across multiple files. I'll now double-check `index-personal.html` and `index-personal-en.html` for any remaining vulnerabilities before updating the task list.
`index-personal.html` is secure now that I've hardened `createSafeURL`. I'll now check `index-bilingual-personal.html` to confirm that `processSocialLinks` has been successfully moved to `bilingual-common.js`.
I've noticed direct `href` assignments in `index-bilingual-personal.html` that use an unvalidated `mapUrl`. I need to investigate its source and ensure it's properly validated.
I've hardened `SecurityUtils.validateURL`, centralized safe domains, and secured `processSocialLinks` and `previewCard` across several key files. I'm now conducting a final check for any remaining problematic `innerHTML` or `href` assignments, starting with `index-personal.html` and `index-personal-en.html`.
I've reviewed the `innerHTML` assignments and found them to be safe, including those in `safeRender` and `nfc-generator.html`. I'm confident my fixes address the CodeQL `js/client-side-unvalidated-url-redirection` and Open Redirect issues. I'll now perform a final check for any missed `window.open` or `window.location` calls.
All location usages are safe, and `index-personal.html` already used `SecurityUtils.createSafeURL`, which my hardening has further secured. Other files like `index.html` were vulnerable due to raw regex replacements, but I've fixed them. I'm now finished with the code changes.
